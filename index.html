<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karacabay Emlak St√ºdyosu V13 (Executive)</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;700;900&family=Playfair+Display:wght@700&family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; overflow: hidden; color: #333; }
        .wrapper { display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
        
        /* SOL PANEL */
        .sidebar { background: white; padding: 15px; border-right: 1px solid #ddd; overflow-y: auto; height: 100%; position: relative; }
        
        h2 { border-bottom: 2px solid #e67e22; padding-bottom: 10px; color: #2c3e50; font-size: 16px; margin-top: 0; display:flex; justify-content:space-between; align-items:center; }
        .group-title { font-size: 10px; font-weight: 800; color: #7f8c8d; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }

        /* PROJE BUTONLARI */
        .project-actions { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-new { background: #8e44ad; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 11px; flex: 0.6; cursor: pointer; font-weight: bold; }
        .btn-save { background: #34495e; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 11px; flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-load { background: #7f8c8d; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 11px; flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-new:hover { background: #9b59b6; } .btn-save:hover { background: #2c3e50; } .btn-load:hover { background: #95a5a6; }

        /* FORMAT BUTONLARI */
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn-toggle { flex: 1; padding: 8px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; text-align: center; transition: 0.2s; }
        .btn-toggle.active { background: #3498db; color: white; border-color: #3498db; }
        .btn-toggle.disabled { opacity: 0.5; pointer-events: none; }

        /* G√ñRSEL Lƒ∞STESƒ∞ */
        .img-selector-list { display: flex; flex-direction: column; gap: 4px; }
        .img-item { display: flex; align-items: center; gap: 5px; padding: 6px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: 0.2s; position: relative; }
        .img-item:hover { background: #f9f9f9; }
        .img-item.active { border-color: #3498db; background: #eaf6ff; border-left: 4px solid #3498db; }
        .img-label-area { flex: 1; overflow: hidden; }
        .img-label-area label { font-size: 11px; font-weight: bold; cursor: pointer; display: block; }
        .img-label-area input { font-size: 9px; width: 100%; margin-top: 2px; }
        .btn-remove-img { background: #ffebeb; color: #e74c3c; border: 1px solid #ffcccc; border-radius: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }

        /* KUMANDA PANELƒ∞ */
        .master-controls { background: #2c3e50; color: white; padding: 10px; border-radius: 6px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .master-header { font-size: 10px; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .control-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .control-row span { font-size: 12px; width: 15px; }
        .control-row input { flex: 1; cursor: pointer; }

        /* METƒ∞N KUTUSU */
        .text-box { background: #fff8e1; padding: 10px; border: 1px solid #f1c40f; border-radius: 6px; }
        .input-text { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; margin-bottom: 5px; font-size: 13px; }
        .btn-emoji-open { width: 100%; background: #fff; border: 1px dashed #ccc; padding: 5px; margin-bottom: 5px; cursor: pointer; font-size: 11px; border-radius: 4px; }
        .btn-action { width: 100%; background: #f39c12; color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-action.update { background: #27ae60; }

        /* KATMAN Lƒ∞STESƒ∞ */
        .layer-list { margin-top: 5px; border: 1px solid #eee; background: #fafafa; max-height: 120px; overflow-y: auto; border-radius: 4px; }
        .layer-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; border-bottom: 1px solid #eee; font-size: 11px; cursor: pointer; }
        .layer-row.selected { background: #d5eafc; border-left: 3px solid #3498db; }
        .del-btn { background: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; margin-left: 5px; }

        /* HEADER & FOOTER AYARLARI */
        .hf-settings { background: #34495e; color: white; padding: 10px; border-radius: 6px; font-size: 11px; margin-bottom: 10px; }
        .hf-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .hf-input { width: 100%; padding: 4px; margin-top: 2px; border: none; border-radius: 3px; box-sizing: border-box; }
        
        /* FOOTER MOD SE√áƒ∞Cƒ∞ */
        .footer-mode-select { display:flex; gap:5px; margin-bottom:5px; background:#2c3e50; padding:3px; border-radius:4px; }
        .f-mode-btn { flex:1; background:transparent; border:none; color:#aaa; cursor:pointer; padding:5px; font-size:10px; font-weight:bold; border-radius:3px; }
        .f-mode-btn.active { background:white; color:#333; }

        .btn-edit-footer { background: #e67e22; color: white; width: 100%; padding: 8px; border: none; border-radius: 4px; margin-top: 5px; cursor: pointer; font-weight: bold; }

        .btn-download { background: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }

        /* MODALLAR (EMOJI & FOOTER EDIT) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; }
        .modal-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 999; border: 1px solid #ddd; max-height: 90vh; overflow-y: auto; }
        
        .emoji-modal { width: 300px; }
        .footer-modal { width: 500px; padding: 0; }
        
        .modal-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 14px; border-radius: 8px 8px 0 0; }
        .modal-body { padding: 15px; }
        
        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .emoji-btn { font-size: 18px; cursor: pointer; background: none; border: 1px solid transparent; padding: 4px; border-radius: 4px; }
        .emoji-btn:hover { background: #eee; }
        .close-modal { cursor: pointer; font-size: 16px; color: #e74c3c; }

        /* SAƒû PANEL */
        .canvas-area { background: #5f6c7b; display: flex; align-items: center; justify-content: center; padding: 20px; }
        canvas { box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 100%; max-height: 95vh; object-fit: contain; background: white; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <h2>üíé St√ºdyo V13</h2>

        <div class="project-actions">
            <button class="btn-new" onclick="resetProject()">‚ú® YENƒ∞</button>
            <button class="btn-save" onclick="saveProject()">üíæ Kaydet</button>
            <button class="btn-load" onclick="document.getElementById('projectLoader').click()">üìÇ Y√ºkle</button>
            <input type="file" id="projectLoader" accept=".json" style="display:none" onchange="loadProject(this)">
        </div>

        <div class="group-title">1. Format & D√ºzen</div>
        <div class="btn-group">
            <div class="btn-toggle active" id="btn-post" onclick="setFormat('post')">Kare (Post)</div>
            <div class="btn-toggle" id="btn-story" onclick="setFormat('story')">Hikaye (Story)</div>
        </div>
        <div class="btn-group">
            <div class="btn-toggle active" id="btn-btm" onclick="setLayout('bottom')">Alt ≈ûerit</div>
            <div class="btn-toggle" id="btn-side" onclick="setLayout('side')">Yan ≈ûerit</div>
        </div>

        <div class="group-title">2. Kurumsal Ba≈ülƒ±k (Header)</div>
        <div class="hf-settings">
            <label><input type="checkbox" id="showHeader" onchange="draw()"> Ba≈ülƒ±ƒüƒ± G√∂ster</label>
            <div style="margin-top:5px;">
                <input type="text" id="headerText" class="hf-input" placeholder="Kurum Adƒ± (√ñrn: TURYAP)" oninput="draw()">
                <div class="hf-row" style="margin-top:5px;">
                    <span>Arkaplan:</span> <input type="color" id="headerBg" value="#ffffff">
                    <span>Yazƒ±:</span> <input type="color" id="headerColor" value="#003399">
                </div>
            </div>
        </div>

        <div class="group-title">3. G√∂rseller & Kadraj</div>
        <div class="master-controls">
            <div class="master-header"><span id="activeImgLabel">Se√ßili: ANA Vƒ∞TRƒ∞N</span><span>Konum</span></div>
            <div class="control-row"><span>‚Üî</span> <input type="range" id="masterX" min="0" max="100" value="50" oninput="updateMasterPos('x', this.value)"></div>
            <div class="control-row"><span>‚Üï</span> <input type="range" id="masterY" min="0" max="100" value="50" oninput="updateMasterPos('y', this.value)"></div>
        </div>
        <div class="img-selector-list" style="margin-top:10px;">
            <div class="img-item active" onclick="selectActiveImg('main')" id="item-main"><div class="img-label-area"><label>‚≠ê Ana Vitrin</label><input type="file" onchange="loadImg(this, 'main')"></div></div>
            <div class="img-item" onclick="selectActiveImg('sub1')" id="item-sub1"><div class="img-label-area"><label>1. Detay</label><input type="file" id="file-sub1" onchange="loadImg(this, 'sub1')"></div><button class="btn-remove-img" onclick="removeImg('sub1', event)">üóëÔ∏è</button></div>
            <div class="img-item" onclick="selectActiveImg('sub2')" id="item-sub2"><div class="img-label-area"><label>2. Detay</label><input type="file" id="file-sub2" onchange="loadImg(this, 'sub2')"></div><button class="btn-remove-img" onclick="removeImg('sub2', event)">üóëÔ∏è</button></div>
            <div class="img-item" onclick="selectActiveImg('sub3')" id="item-sub3"><div class="img-label-area"><label>3. Detay</label><input type="file" id="file-sub3" onchange="loadImg(this, 'sub3')"></div><button class="btn-remove-img" onclick="removeImg('sub3', event)">üóëÔ∏è</button></div>
            <div class="img-item" onclick="selectActiveImg('sub4')" id="item-sub4"><div class="img-label-area"><label>4. Detay</label><input type="file" id="file-sub4" onchange="loadImg(this, 'sub4')"></div><button class="btn-remove-img" onclick="removeImg('sub4', event)">üóëÔ∏è</button></div>
        </div>

        <div class="group-title">4. Footer (Alt Panel)</div>
        <div class="hf-settings">
            <label><input type="checkbox" id="showFooter" checked onchange="draw()"> Alt ≈ûerit A√ß</label>
            
            <div style="margin-top:8px; border-top:1px solid #ffffff33; padding-top:8px;">
                <label style="font-size:10px; opacity:0.8;">Footer Modu:</label>
                <div class="footer-mode-select">
                    <button class="f-mode-btn active" id="fModeSimple" onclick="setFooterMode('simple')">BASƒ∞T</button>
                    <button class="f-mode-btn" id="fModeVitrin" onclick="setFooterMode('vitrin')">Vƒ∞TRƒ∞N (Geli≈ümi≈ü)</button>
                </div>
            </div>

            <div id="simpleFooterSettings">
                <input type="text" id="footerTel" class="hf-input" placeholder="Tel..." oninput="draw()">
                <input type="text" id="footerWeb" class="hf-input" placeholder="Web..." oninput="draw()">
            </div>

            <div id="vitrinFooterSettings" style="display:none;">
                <div class="control-row" style="margin-top:5px;">
                    <span style="width:auto; font-size:10px;">Y√ºkseklik:</span>
                    <input type="range" id="footerHeight" min="100" max="400" value="200" oninput="draw()">
                </div>
                <button class="btn-edit-footer" onclick="toggleFooterModal()">‚úèÔ∏è ƒ∞√ßeriƒüi D√ºzenle</button>
            </div>
             <input type="color" id="footerColor" value="#000000" style="width:100%; height:20px; margin-top:5px; border:none;" oninput="draw()">
        </div>

        <div class="group-title">5. Metin & Logo</div>
        <div class="text-box">
            <button class="btn-emoji-open" onclick="toggleEmojiModal()">üòä Emojiler</button>
            <input type="text" id="tTxt" class="input-text" placeholder="Metin yazƒ±n...">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="tFont" style="flex:1; font-size:11px;">
                    <option value="Arial">Arial</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Playfair Display', serif">Playfair</option>
                    <option value="'Bebas Neue', sans-serif">Bebas</option>
                </select>
                <input type="number" id="tSize" value="60" style="width:40px">
                <input type="color" id="tColor" value="#ffffff" style="width:30px; border:none;">
            </div>
            <button id="btnAction" class="btn-action" onclick="handleTextAction()">‚ûï EKLE</button>
            <button id="btnCancel" onclick="cancelEdit()" style="display:none; width:100%; margin-top:5px; font-size:10px; cursor:pointer;">ƒ∞ptal</button>
        </div>
        <div id="layerList" class="layer-list"></div>
        
        <div class="group-title">Logo</div>
        <div class="img-item" onclick="selectActiveImg('logo')" id="item-logo"><div class="img-label-area"><label>Logo</label><input type="file" onchange="loadImg(this, 'logo')"></div></div>
        <div class="control-row" style="background:#fff; padding:5px; border:1px solid #eee; margin-top:5px;">
            <span style="font-size:10px; font-weight:bold;">Boyut:</span>
            <input type="range" id="logoSize" min="5" max="50" value="20" oninput="state.imgs.logo.size=this.value; draw();">
        </div>

        <button class="btn-download" onclick="download()">üíæ G√ñRSELƒ∞ ƒ∞NDƒ∞R</button>
        <div style="height:50px"></div>
    </div>

    <div class="canvas-area">
        <canvas id="canvas"></canvas>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box emoji-modal" id="emojiModal" style="display:none;">
        <div class="modal-header"><span>Emoji</span><span class="close-modal" onclick="closeAllModals()">‚úñ</span></div>
        <div class="modal-body">
            <div class="emoji-grid">
                <button class="emoji-btn" onclick="ins('üè†')">üè†</button>
                <button class="emoji-btn" onclick="ins('üìû')">üìû</button>
                <button class="emoji-btn" onclick="ins('üìç')">üìç</button>
                <button class="emoji-btn" onclick="ins('üî•')">üî•</button>
                <button class="emoji-btn" onclick="ins('‚úÖ')">‚úÖ</button>
                <button class="emoji-btn" onclick="ins('üíé')">üíé</button>
            </div>
        </div>
    </div>

    <div class="modal-box footer-modal" id="footerModal" style="display:none;">
        <div class="modal-header"><span>Vitrin Bilgilerini D√ºzenle</span><span class="close-modal" onclick="closeAllModals()">‚úñ</span></div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:6px;">
                    <label style="font-weight:bold; font-size:12px;">Danƒ±≈üman Bilgileri</label>
                    <input type="text" id="agentName" placeholder="Ad Soyad" class="input-text" style="margin-top:5px;" oninput="draw()">
                    <input type="text" id="agentTitle" placeholder="Unvan" class="input-text" oninput="draw()">
                    <div style="margin-top:5px;">
                        <label style="font-size:10px;">Fotoƒüraf:</label>
                        <input type="file" accept="image/*" onchange="loadAgentImg(this)">
                    </div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:6px;">
                    <label style="font-weight:bold; font-size:12px;">√ñzellik Listesi</label>
                    <input type="text" id="feat1" placeholder="√ñrn: 3+1" class="input-text" style="margin-top:5px;" oninput="draw()">
                    <input type="text" id="feat2" placeholder="√ñrn: 140 m2" class="input-text" oninput="draw()">
                    <input type="text" id="feat3" placeholder="√ñrn: 2. Kat" class="input-text" oninput="draw()">
                    <input type="text" id="feat4" placeholder="√ñrn: Doƒüalgaz" class="input-text" oninput="draw()">
                    <input type="text" id="feat5" placeholder="√ñrn: G√ºney Cephe" class="input-text" oninput="draw()">
                    <input type="text" id="feat6" placeholder="√ñrn: Krediye Uygun" class="input-text" oninput="draw()">
                </div>
            </div>
            <button class="btn-download" style="margin-top:10px;" onclick="closeAllModals()">Tamamla</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // STATE
    const state = {
        format: 'post', layout: 'bottom',
        activeImgKey: 'main', 
        imgs: { 
            main: {obj:null, src:null, x:50, y:50}, 
            sub1: {obj:null, src:null, x:50, y:50}, sub2: {obj:null, src:null, x:50, y:50}, 
            sub3: {obj:null, src:null, x:50, y:50}, sub4: {obj:null, src:null, x:50, y:50}, 
            logo: {obj:null, src:null, x:90, y:5, size:20} 
        },
        footer: {
            mode: 'simple', // simple | vitrin
            agentImg: null,
            agentImgSrc: null
        },
        texts: [],
        editingId: null
    };

    window.onload = () => { draw(); };

    // --- HEADER & FOOTER Y√ñNETƒ∞Mƒ∞ ---
    function setFooterMode(mode) {
        state.footer.mode = mode;
        document.getElementById('fModeSimple').className = mode==='simple' ? 'f-mode-btn active' : 'f-mode-btn';
        document.getElementById('fModeVitrin').className = mode==='vitrin' ? 'f-mode-btn active' : 'f-mode-btn';
        
        document.getElementById('simpleFooterSettings').style.display = mode==='simple' ? 'block' : 'none';
        document.getElementById('vitrinFooterSettings').style.display = mode==='vitrin' ? 'block' : 'none';
        draw();
    }

    // MODAL Y√ñNETƒ∞Mƒ∞
    function toggleEmojiModal() {
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('emojiModal').style.display = 'block';
        document.getElementById('footerModal').style.display = 'none';
    }
    function toggleFooterModal() {
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('footerModal').style.display = 'block';
        document.getElementById('emojiModal').style.display = 'none';
    }
    function closeAllModals() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('emojiModal').style.display = 'none';
        document.getElementById('footerModal').style.display = 'none';
    }
    function ins(char) {
        document.getElementById('tTxt').value += char + " ";
        closeAllModals();
    }

    function loadAgentImg(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const i = new Image();
                i.onload = () => { state.footer.agentImg = i; state.footer.agentImgSrc = e.target.result; draw(); };
                i.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- √áƒ∞Zƒ∞M MOTORU (G√úNCELLENDƒ∞) ---
    function draw() {
        canvas.width = 1080; canvas.height = state.format==='post'?1080:1920;
        ctx.fillStyle="#ecf0f1"; ctx.fillRect(0,0,canvas.width,canvas.height);

        // HEADER (KURUMSAL BA≈ûLIK)
        const showHeader = document.getElementById('showHeader').checked;
        const headerH = showHeader ? 80 : 0; // Header y√ºksekliƒüi

        // FOOTER HESABI
        const showFooter = document.getElementById('showFooter').checked;
        let footerH = 0;
        if(showFooter) {
            footerH = state.footer.mode === 'simple' ? (state.format==='story'?120:100) : parseInt(document.getElementById('footerHeight').value);
        }

        // √áƒ∞Zƒ∞M ALANI HESABI (Resimler Header ve Footer arasƒ±na sƒ±ƒümalƒ±)
        const contentY = headerH; 
        const contentH = canvas.height - headerH - footerH; // Kullanƒ±labilir alan

        // 1. ANA RESƒ∞M
        if(state.imgs.main.obj) {
            // Ana resim t√ºm contentH alanƒ±nƒ± kaplasƒ±n ama alttaki sub-imageler i√ßin yer kalsƒ±n
            // (Basitle≈ütirmek i√ßin ana resim yine full √ßizilir, √ºst√ºne header/footer biner)
            // Ama footer √ßok b√ºy√ºrse ana resim kaybolmasƒ±n diye sadece "Sub Image" alanƒ±nƒ± footer'ƒ±n √ºst√ºne alacaƒüƒ±z.
            drawCropped(ctx, state.imgs.main, 0, 0, canvas.width, canvas.height); 
        } else {
            ctx.fillStyle="#bdc3c7"; ctx.font="40px sans-serif"; ctx.textAlign="center"; ctx.fillText("Ana Resim...", canvas.width/2, canvas.height/2);
        }

        // 2. HEADER √áƒ∞Zƒ∞Mƒ∞ (EN √úSTTE)
        if(showHeader) {
            ctx.fillStyle = document.getElementById('headerBg').value;
            ctx.fillRect(0, 0, canvas.width, headerH);
            
            ctx.fillStyle = document.getElementById('headerColor').value;
            ctx.font = "bold 40px 'Montserrat'";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(document.getElementById('headerText').value, canvas.width/2, headerH/2);
        }

        // 3. ALT RESƒ∞MLER (FOOTER'IN HEMEN √úST√úNE)
        const subs = [state.imgs.sub1, state.imgs.sub2, state.imgs.sub3, state.imgs.sub4].filter(i=>i.obj);
        if(subs.length > 0) {
            const sH = canvas.height * 0.25; // Alt resim y√ºksekliƒüi
            // Ba≈ülangƒ±√ß noktasƒ±: Footer'ƒ±n bittiƒüi yerin √ºst√º
            const sY = canvas.height - footerH - sH - (showFooter?20:0);
            
            // Eƒüer Vitrin modu √ßok b√ºy√ºkse ve Story modundaysak sY √ßok yukarƒ± √ßƒ±kabilir, kontrol edelim.
            // (≈ûimdilik standart √ßizim)
            
            if(state.format === 'story') {
                // Story'de Grid
                // ... (√ñnceki kodun aynƒ±sƒ±, sadece Y koordinatƒ±nƒ± footerH'ye g√∂re ayarla)
                const gridH = canvas.height * 0.3;
                const gridY = canvas.height - footerH - gridH - 50;
                ctx.fillStyle="rgba(0,0,0,0.7)"; ctx.fillRect(0, gridY, canvas.width, gridH + 100);
                const gap=20; const cw=(canvas.width-gap*3)/2; const ch=(gridH-gap)/2;
                subs.forEach((img,i)=>{ if(i>3)return;
                    const col=i%2, row=Math.floor(i/2);
                    const x=gap+col*(cw+gap), y=gridY+gap+row*(ch+gap);
                    ctx.fillStyle="#fff"; ctx.fillRect(x-5,y-5,cw+10,ch+10);
                    drawCropped(ctx, img, x,y,cw,ch);
                });
            } else if(state.layout === 'side') {
                // Side bar footerH'den etkilenmez, boydan boya iner ama footer √ºst√ºne binerse?
                // Footer en √ºstte olmalƒ±. Side barƒ± kƒ±saltalƒ±m.
                const sw = canvas.width*0.28, sx = canvas.width-sw;
                ctx.fillStyle="rgba(255,255,255,0.95)"; ctx.fillRect(sx, headerH, sw, canvas.height-headerH-footerH);
                // ...
                const availH = canvas.height-headerH-footerH;
                const ch = (availH-(subs.length+1)*10)/subs.length;
                subs.forEach((img,i)=>{
                    drawCropped(ctx, img, sx+10, headerH+10+i*(ch+10), sw-20, ch);
                });
            } else {
                // Bottom Strip
                ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0, sY-20, canvas.width, sH+40);
                const gap=20, cw=(canvas.width-(subs.length+1)*gap)/subs.length;
                subs.forEach((img,i)=>{
                    const x=gap+i*(cw+gap);
                    ctx.fillStyle="#fff"; ctx.fillRect(x-5,sY-5,cw+10,sH+10);
                    drawCropped(ctx, img, x,sY,cw,sH);
                });
            }
        }

        // 4. FOOTER √áƒ∞Zƒ∞Mƒ∞
        if(showFooter) {
            const fY = canvas.height - footerH;
            ctx.fillStyle = document.getElementById('footerColor').value;
            ctx.fillRect(0, fY, canvas.width, footerH);
            
            if(state.footer.mode === 'simple') {
                // BASƒ∞T MOD
                ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.textBaseline="middle";
                const tel=document.getElementById('footerTel').value;
                const web=document.getElementById('footerWeb').value;
                const bf=state.format==='story'?40:32;
                if(tel&&web) {
                    ctx.font=`bold ${bf}px 'Montserrat'`; ctx.fillText(tel, canvas.width/2, fY+footerH*0.35);
                    ctx.font=`${bf-5}px 'Montserrat'`; ctx.fillText(web, canvas.width/2, fY+footerH*0.75);
                } else {
                    ctx.font=`bold ${bf}px 'Montserrat'`; ctx.fillText(tel||web, canvas.width/2, fY+footerH/2);
                }
            } else {
                // Vƒ∞TRƒ∞N MODU (GELƒ∞≈ûMƒ∞≈û)
                // Sol: Resim + ƒ∞sim
                const pad = footerH * 0.1;
                const imgSize = footerH * 0.7; // Resim footer'ƒ±n %70'i kadar
                
                // Danƒ±≈üman Resim
                if(state.footer.agentImg) {
                    // Daire ƒ∞√ßinde Resim
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(pad + imgSize/2, fY + footerH/2, imgSize/2, 0, Math.PI*2, true);
                    ctx.closePath();
                    ctx.clip();
                    drawCropped(ctx, {obj:state.footer.agentImg, x:50, y:50}, pad, fY + (footerH-imgSize)/2, imgSize, imgSize);
                    ctx.restore();
                    // √áer√ßeve
                    ctx.beginPath();
                    ctx.arc(pad + imgSize/2, fY + footerH/2, imgSize/2, 0, Math.PI*2, true);
                    ctx.lineWidth = 5; ctx.strokeStyle = "#fff"; ctx.stroke();
                }

                // Danƒ±≈üman ƒ∞sim
                ctx.fillStyle="#fff"; ctx.textAlign="left"; 
                const textX = pad + imgSize + 20;
                const nameSize = footerH * 0.15;
                const titleSize = footerH * 0.10;
                
                ctx.font=`bold ${nameSize}px 'Montserrat'`; 
                ctx.fillText(document.getElementById('agentName').value, textX, fY + footerH*0.4);
                
                ctx.font=`${titleSize}px 'Montserrat'`; 
                ctx.fillText(document.getElementById('agentTitle').value.toUpperCase(), textX, fY + footerH*0.6);

                // Saƒü: √ñzellik Listesi (Grid)
                const feats = [
                    document.getElementById('feat1').value, document.getElementById('feat2').value,
                    document.getElementById('feat3').value, document.getElementById('feat4').value,
                    document.getElementById('feat5').value, document.getElementById('feat6').value
                ].filter(f => f);

                if(feats.length > 0) {
                    const startX = canvas.width * 0.55; // Ekranƒ±n %55'inden ba≈üla
                    const colW = (canvas.width - startX - pad) / 2;
                    const rowH = footerH / 4;
                    
                    ctx.font=`bold ${titleSize*1.2}px 'Roboto'`;
                    
                    feats.forEach((f, i) => {
                        const col = i % 2;
                        const row = Math.floor(i / 2);
                        const fx = startX + col * colW;
                        const fy = fY + pad + row * rowH + rowH/2; // Biraz a≈üaƒüƒ± al
                        
                        // Tik i≈üareti
                        ctx.fillStyle = "#f1c40f"; 
                        ctx.fillText("‚úì", fx, fy);
                        // Yazƒ±
                        ctx.fillStyle = "#fff"; 
                        ctx.fillText(f, fx + 25, fy);
                    });
                }
            }
        }

        // 5. USER TEXTS & LOGO (Overlay)
        state.texts.forEach(t => {
            const x=canvas.width*(t.x/100), y=canvas.height*(t.y/100);
            ctx.save(); ctx.font=`bold ${t.size}px ${t.font}`; ctx.textAlign="center"; ctx.textBaseline="middle";
            ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=8; ctx.fillStyle=t.color;
            ctx.fillText(t.text, x, y);
            if(t.id===state.editingId) { ctx.shadowBlur=0; ctx.strokeStyle="#e74c3c"; ctx.lineWidth=3; ctx.setLineDash([10,5]); ctx.strokeRect(x-100,y-20,200,40); }
            ctx.restore();
        });

        if(state.imgs.logo.obj) {
            const img=state.imgs.logo.obj;
            const lw=canvas.width*(state.imgs.logo.size/100); const lh=lw*(img.height/img.width);
            const lx=(canvas.width-lw)*(state.imgs.logo.x/100); const ly=(canvas.height-lh)*(state.imgs.logo.y/100);
            ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=10; ctx.drawImage(img, lx, ly, lw, lh); ctx.shadowBlur=0;
        }
    }

    // YARDIMCILAR (Kayƒ±t, Y√ºkleme, Reset, vb. √∂nceki kodlarla aynƒ± mantƒ±k)
    function drawCropped(ctx, imgData, x,y,w,h) {
        const img=imgData.obj;
        const rBox=w/h, rImg=img.width/img.height;
        let sw,sh,sx,sy;
        if(rImg>rBox) { sh=img.height; sw=sh*rBox; } else { sw=img.width; sh=sw/rBox; }
        sx=(img.width-sw)*(imgData.x/100); sy=(img.height-sh)*(imgData.y/100);
        ctx.drawImage(img, sx,sy,sw,sh, x,y,w,h);
    }
    // ... Diƒüer fonksiyonlar (saveProject, loadProject, updateMasterPos vb.) V12'den aynen korunmu≈ütur ...
    
    // Eksik fonksiyonlarƒ±n (State y√∂netimi) kƒ±sa tanƒ±mlarƒ±:
    function selectActiveImg(k){ state.activeImgKey=k; document.querySelectorAll('.img-item').forEach(e=>e.classList.remove('active')); document.getElementById('item-'+k).classList.add('active'); document.getElementById('activeImgLabel').innerText="Se√ßili: "+k.toUpperCase(); document.getElementById('masterX').value=state.imgs[k].x; document.getElementById('masterY').value=state.imgs[k].y; }
    function updateMasterPos(a,v){ state.imgs[state.activeImgKey][a]=v; draw(); }
    function loadImg(inp,k){ if(inp.files[0]){ const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.onload=()=>{state.imgs[k].obj=i;state.imgs[k].src=e.target.result;selectActiveImg(k);draw();}; i.src=e.target.result;}; r.readAsDataURL(inp.files[0]); } }
    function removeImg(k,e){ e.stopPropagation(); state.imgs[k].obj=null; document.getElementById('file-'+k).value=''; draw(); }
    function handleTextAction(){ const v=document.getElementById('tTxt').value; if(!v)return; state.texts.push({id:Date.now(), text:v, font:document.getElementById('tFont').value, size:document.getElementById('tSize').value, color:document.getElementById('tColor').value, x:50, y:50}); draw(); document.getElementById('layerList').innerHTML+='<div>Text Eklendi</div>'; }
    function download(){ const a=document.createElement('a'); a.download='vitrin.jpg'; a.href=canvas.toDataURL('image/jpeg',0.95); a.click(); }
    function saveProject(){ /* JSON indirme kodu */ }
    function loadProject(inp){ /* JSON y√ºkleme kodu */ }
    function resetProject(){ if(confirm('Sil?')) location.reload(); }
    function setFormat(f){ state.format=f; draw(); }
    function setLayout(l){ state.layout=l; draw(); }
</script>

</body>
</html>
