<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak St√ºdyosu V22 PRO (Ultra Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2c3e50; --accent: #f1c40f; --success: #27ae60; --danger: #e74c3c; --sidebar-bg: #ffffff; }
        body { font-family: 'Montserrat', sans-serif; background: #1a1a2e; margin: 0; height: 100vh; overflow: hidden; color: #333; }
        .wrapper { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
        
        /* SIDEBAR TASARIMI */
        .sidebar { background: var(--sidebar-bg); padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .brand-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .brand-header h1 { font-size: 22px; font-weight: 900; color: var(--primary); margin: 0; letter-spacing: -1px; }
        .brand-header span { color: var(--accent); font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 3px; }

        /* GRUPLANDIRMA */
        .section { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .group-title { font-size: 11px; font-weight: 800; color: #95a5a6; text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; }

        /* BUTONLAR */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; font-family: 'Montserrat'; }
        .btn-main { background: var(--primary); color: white; padding: 10px; font-size: 11px; }
        .btn-undo { background: #9b59b6; color: white; padding: 10px; font-size: 11px; }
        .btn-wa { background: #25D366; color: white; padding: 12px; font-size: 14px; width: 100%; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-wa:hover { background: #128C7E; transform: translateY(-2px); }

        /* KONTROLLER */
        .master-panel { background: #2c3e50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 11px; }
        .control-row input[type="range"] { flex: 1; accent-color: var(--accent); }

        /* G√ñRSEL SE√áƒ∞Cƒ∞ */
        .img-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .img-box { border: 2px solid #eee; border-radius: 5px; padding: 5px; text-align: center; cursor: pointer; font-size: 9px; font-weight: bold; }
        .img-box.active { border-color: var(--accent); background: #fef9e7; }
        .img-box input { display: none; }

        /* METƒ∞N ALANI */
        .text-area { background: #fff; border: 2px solid var(--accent); border-radius: 8px; padding: 10px; }
        .input-custom { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 8px; box-sizing: border-box; }

        /* CANVAS */
        .canvas-area { position: relative; display: flex; align-items: center; justify-content: center; overflow: auto; background: #1a1a2e; }
        canvas { background: white; box-shadow: 0 0 50px rgba(0,0,0,0.5); border: 1px solid #333; cursor: crosshair; }
        
        .safe-zone-info { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px; font-size: 10px; pointer-events: none; }

        /* MODALLAR */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 350px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-header">
            <h1>EMLAK ST√úDYOSU</h1>
            <span>V22 PRO DESIGNER</span>
        </div>

        <div class="btn-grid">
            <button class="btn-undo" onclick="undo()">‚Ü©Ô∏è GERƒ∞ AL</button>
            <button class="btn-main" onclick="location.reload()">‚ú® SIFIRLA</button>
        </div>

        <div class="section">
            <div class="group-title">≈ûablon Sistemi</div>
            <input type="text" id="tmpName" class="input-custom" style="padding:5px;" placeholder="≈ûablon adƒ±...">
            <button class="btn-main" style="width:100%; background:var(--success)" onclick="saveTemplate()">üíæ ≈ûABLONU HAFIZAYA KAYDET</button>
            <div id="templateList" style="margin-top:8px; max-height:80px; overflow-y:auto;"></div>
        </div>

        <div class="master-panel">
            <div id="activeLabel" style="color:var(--accent); font-size:10px; margin-bottom:8px; font-weight:bold;">Se√ßili: Ana Vitrin</div>
            <div class="control-row"><span>X</span> <input type="range" id="mX" min="0" max="100" oninput="updateProp('x', this.value)"></div>
            <div class="control-row"><span>Y</span> <input type="range" id="mY" min="0" max="100" oninput="updateProp('y', this.value)"></div>
            <div class="control-row" id="mSizeRow"><span>Boyut</span> <input type="range" id="mSize" min="5" max="100" oninput="updateProp('size', this.value)"></div>
        </div>

        <div class="section">
            <div class="group-title">G√∂rsel Katmanlarƒ±</div>
            <div class="img-list">
                <div class="img-box active" id="box-main" onclick="sel('main')">Vitrin<input type="file" onchange="loadImg(this,'main')"></div>
                <div class="img-box" id="box-sub1" onclick="sel('sub1')">Detay 1<input type="file" onchange="loadImg(this,'sub1')"></div>
                <div class="img-box" id="box-sub2" onclick="sel('sub2')">Detay 2<input type="file" onchange="loadImg(this,'sub2')"></div>
                <div class="img-box" id="box-logo1" onclick="sel('logo1')">Logo 1<input type="file" onchange="loadImg(this,'logo1')"></div>
                <div class="img-box" id="box-logo2" onclick="sel('logo2')">Logo 2<input type="file" onchange="loadImg(this,'logo2')"></div>
                <div class="img-box" style="background:#eee" onclick="openFooterModal()">Footer D√ºzenle</div>
            </div>
        </div>

        <div class="section">
            <div class="group-title">Metin Tasarƒ±mƒ±</div>
            <div class="text-area">
                <input type="text" id="tInput" class="input-custom" placeholder="Metin yazƒ±n...">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <label style="font-size:10px; font-weight:bold;"><input type="checkbox" id="tGlow" onchange="draw()"> üåü √ñNE √áIKAR</label>
                    <input type="color" id="tColor" value="#ffffff" oninput="draw()">
                </div>
                <button class="btn-main" style="width:100%; background:var(--success)" onclick="addText()">‚ûï METƒ∞N EKLE / G√úNCELLE</button>
            </div>
            <div id="layerList" style="margin-top:5px; max-height:80px; overflow-y:auto; font-size:10px;"></div>
        </div>

        <button class="btn-wa" onclick="shareWhatsApp()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.316 1.592 5.448 0 9.886-4.438 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.818-.981z"/></svg>
            WHATSAPP ƒ∞LE PAYLA≈û
        </button>
        <button class="btn-main" style="width:100%; margin-top:5px;" onclick="download()">üíæ G√ñRSELƒ∞ ƒ∞NDƒ∞R</button>
        <div style="text-align:center; margin-top:10px;">
            <label style="font-size:10px; color:#95a5a6;"><input type="checkbox" id="showSafeZone" onchange="draw()"> WhatsApp G√ºvenli Alanƒ± G√∂ster</label>
        </div>
    </div>

    <div class="canvas-area">
        <div class="safe-zone-info">4:5 & 1:1 Smart Preview Active</div>
        <canvas id="canvas"></canvas>
    </div>
</div>

<div id="footerModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Footer Bilgileri</h3>
        <input type="text" id="fTel" placeholder="Telefon" class="input-custom" oninput="draw()">
        <input type="text" id="fWeb" placeholder="Web Sitesi" class="input-custom" oninput="draw()">
        <input type="text" id="fName" placeholder="Danƒ±≈üman Adƒ±" class="input-custom" oninput="draw()">
        <hr>
        <button class="btn-main" style="width:100%" onclick="closeFooterModal()">KAYDET VE KAPAT</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // --- STATE & HISTORY ---
    let state = {
        format: 'post', activeKey: 'main',
        imgs: {
            main: {obj:null, src:null, x:50, y:50, size:100},
            sub1: {obj:null, src:null, x:20, y:80, size:25},
            sub2: {obj:null, src:null, x:50, y:80, size:25},
            logo1: {obj:null, src:null, x:5, y:5, size:15},
            logo2: {obj:null, src:null, x:80, y:5, size:15}
        },
        texts: [], editingId: null,
        footer: { show:true, tel:'', web:'', name:'' },
        history: []
    };

    function saveToHistory() {
        const snapshot = JSON.stringify(state);
        if (state.history.length > 20) state.history.shift();
        state.history.push(snapshot);
    }

    function undo() {
        if (state.history.length > 1) {
            state.history.pop(); // Mevcut durumu at
            const last = state.history[state.history.length - 1];
            const data = JSON.parse(last);
            Object.assign(state, data);
            state.history = data.history; // History'i koru
            // Resimleri yeniden canlandƒ±r
            for(let k in state.imgs) {
                if(state.imgs[k].src) {
                    const i = new Image(); i.onload = draw; i.src = state.imgs[k].src;
                    state.imgs[k].obj = i;
                }
            }
            draw(); renderLayers();
        }
    }

    // --- INTERACTION ---
    let isDragging = false, isResizing = false, dragTarget = null, lastX=0, lastY=0;

    canvas.addEventListener('mousedown', e => {
        const {x, y} = getMousePos(e);
        saveToHistory();

        // 1. Logo Resize Handle
        if(state.activeKey.startsWith('logo')) {
            const d = state.imgs[state.activeKey];
            if(d.obj && checkResize(x, y, d)) { isResizing = true; return; }
        }
        // 2. Metin Drag
        for(let t of state.texts) {
            const tx = canvas.width*(t.x/100), ty = canvas.height*(t.y/100);
            if(Math.abs(x-tx)<100 && Math.abs(y-ty)<30) {
                state.editingId = t.id; loadTextToEdit(t.id);
                isDragging = true; dragTarget = t; return;
            }
        }
        // 3. Image Drag
        for(let k in state.imgs) {
            if(k === 'main') continue;
            if(state.imgs[k].obj && isInside(x, y, state.imgs[k])) {
                sel(k); isDragging = true; dragTarget = state.imgs[k]; return;
            }
        }
    });

    canvas.addEventListener('mousemove', e => {
        const {x, y} = getMousePos(e);
        const dx = (x - lastX)/canvas.width*100, dy = (y - lastY)/canvas.height*100;
        if(isDragging && dragTarget) { dragTarget.x += dx; dragTarget.y += dy; draw(); updatePanel(); }
        else if(isResizing) { state.imgs[state.activeKey].size += dx; draw(); updatePanel(); }
        lastX = x; lastY = y;
    });

    window.addEventListener('mouseup', () => { isDragging = false; isResizing = false; });

    // --- DRAWING ---
    function draw() {
        canvas.width = 1080; canvas.height = 1350; // WhatsApp Portrait (4:5) En ideal format
        ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width, canvas.height);

        if(state.imgs.main.obj) drawCropped(ctx, state.imgs.main, 0,0, 1080, 1350);

        // Sub images
        ['sub1', 'sub2'].forEach(k => {
            const d = state.imgs[k];
            if(d.obj) {
                const w = canvas.width*(d.size/100), h = w*(d.obj.height/d.obj.width);
                drawCropped(ctx, d, canvas.width*(d.x/100), canvas.height*(d.y/100), w, h);
            }
        });

        // Footer
        if(state.footer.show) {
            ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0, 1200, 1080, 150);
            ctx.fillStyle = "#fff"; ctx.textAlign = "left"; ctx.font = "bold 35px Montserrat";
            ctx.fillText(state.footer.tel + " | " + state.footer.web, 50, 1260);
            ctx.fillStyle = varColor('--accent'); ctx.font = "bold 25px Montserrat";
            ctx.fillText(state.footer.name.toUpperCase(), 50, 1300);
        }

        // Texts
        state.texts.forEach(t => {
            ctx.save();
            const tx = canvas.width*(t.x/100), ty = canvas.height*(t.y/100);
            ctx.textAlign = "center"; ctx.font = `bold ${t.size}px Montserrat`;
            if(t.glow) { ctx.shadowColor="black"; ctx.shadowBlur=30; ctx.strokeText(t.text, tx, ty); }
            ctx.fillStyle = t.color; ctx.fillText(t.text, tx, ty);
            if(state.editingId === t.id) { ctx.strokeStyle=varColor('--accent'); ctx.lineWidth=3; ctx.strokeRect(tx-150, ty-40, 300, 70); }
            ctx.restore();
        });

        // Logos
        ['logo1', 'logo2'].forEach(k => {
            const d = state.imgs[k];
            if(d.obj) {
                const w = canvas.width*(d.size/100), h = w*(d.obj.height/d.obj.width);
                const lx = canvas.width*(d.x/100), ly = canvas.height*(d.y/100);
                ctx.drawImage(d.obj, lx, ly, w, h);
                if(state.activeKey === k) {
                    ctx.strokeStyle="cyan"; ctx.strokeRect(lx, ly, w, h);
                    ctx.fillStyle="red"; ctx.fillRect(lx+w-15, ly+h-15, 30, 30);
                }
            }
        });

        // Safe Zone Overlay
        if(document.getElementById('showSafeZone').checked) {
            ctx.strokeStyle = "rgba(255,255,255,0.5)"; ctx.setLineDash([10,10]);
            ctx.strokeRect(0, 135, 1080, 1080); // 1:1 Square Safe Zone
            ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fillRect(0,0,1080,135); ctx.fillRect(0,1215,1080,135);
            ctx.setLineDash([]);
        }
    }

    // --- ACTIONS ---
    function addText() {
        const val = document.getElementById('tInput').value; if(!val) return;
        saveToHistory();
        if(state.editingId) {
            const t = state.texts.find(x => x.id === state.editingId);
            t.text = val; t.glow = document.getElementById('tGlow').checked; t.color = document.getElementById('tColor').value;
        } else {
            state.texts.push({id:Date.now(), text:val, x:50, y:50, size:60, color:document.getElementById('tColor').value, glow:document.getElementById('tGlow').checked});
        }
        draw(); renderLayers();
    }

    function shareWhatsApp() {
        // WhatsApp i√ßin 1:1 merkezli okunaklƒ± g√∂rsel optimizasyonu
        const link = document.createElement('a');
        canvas.toBlob(blob => {
            const file = new File([blob], "ilan.jpg", {type: "image/jpeg"});
            if (navigator.share) {
                navigator.share({ files: [file], title: 'Emlak ƒ∞lanƒ±', text: 'Yeni portf√∂y yayƒ±nda!' });
            } else {
                download();
                alert("Tarayƒ±cƒ±nƒ±z doƒürudan payla≈üƒ±mƒ± desteklemiyor. G√∂rsel indirildi, manuel payla≈üabilirsiniz.");
            }
        }, 'image/jpeg', 0.9);
    }

    // --- TEMPLATE & STORAGE ---
    function saveTemplate() {
        const name = document.getElementById('tmpName').value || "≈ûablon";
        const temps = JSON.parse(localStorage.getItem('emlak_pro_temps') || '{}');
        const snap = JSON.parse(JSON.stringify(state));
        for(let k in snap.imgs) snap.imgs[k].obj = null;
        temps[name] = snap;
        localStorage.setItem('emlak_pro_temps', JSON.stringify(temps));
        refreshTemplates();
    }

    function refreshTemplates() {
        const list = document.getElementById('templateList');
        const temps = JSON.parse(localStorage.getItem('emlak_pro_temps') || '{}');
        list.innerHTML = "";
        for(let n in temps) {
            const d = document.createElement('div');
            d.style = "display:flex; justify-content:space-between; font-size:10px; padding:3px; border-bottom:1px solid #ddd; cursor:pointer;";
            d.innerHTML = `<span onclick="loadT('${n}')">üìÅ ${n}</span> <b onclick="delT('${n}')" style="color:red">‚úñ</b>`;
            list.appendChild(d);
        }
    }

    // --- HELPERS ---
    function sel(k) {
        state.activeKey = k;
        document.querySelectorAll('.img-box').forEach(b => b.classList.remove('active'));
        document.getElementById('box-'+k).classList.add('active');
        document.getElementById('activeLabel').innerText = "Se√ßili: " + k.toUpperCase();
        updatePanel(); draw();
    }
    function updatePanel() {
        const d = state.imgs[state.activeKey];
        document.getElementById('mX').value = d.x; document.getElementById('mY').value = d.y; document.getElementById('mSize').value = d.size;
        document.getElementById('mSizeRow').style.display = state.activeKey==='main' ? 'none' : 'flex';
    }
    function updateProp(a,v) { if(state.activeKey) { state.imgs[state.activeKey][a] = parseFloat(v); draw(); } }
    function loadImg(inp, k) { if(inp.files[0]) { 
        saveToHistory();
        const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.onload=draw; i.src=e.target.result; state.imgs[k].obj=i; state.imgs[k].src=e.target.result; sel(k); }; r.readAsDataURL(inp.files[0]); 
    } }
    function getMousePos(e) { const r=canvas.getBoundingClientRect(); return { x:(e.clientX-r.left)*(canvas.width/r.width), y:(e.clientY-r.top)*(canvas.height/r.height) }; }
    function isInside(mx, my, d) { const w=canvas.width*(d.size/100), h=w*(d.obj.height/d.obj.width), lx=canvas.width*(d.x/100), ly=canvas.height*(d.y/100); return mx>lx && mx<lx+w && my>ly && my<ly+h; }
    function checkResize(mx, my, d) { const w=canvas.width*(d.size/100), h=w*(d.obj.height/d.obj.width), lx=canvas.width*(d.x/100)+w, ly=canvas.height*(d.y/100)+h; return Math.abs(mx-lx)<30 && Math.abs(my-ly)<30; }
    function drawCropped(ctx, d, x, y, w, h) { const img=d.obj, rI=img.width/img.height, rC=w/h; let sw, sh, sx, sy; if(rI>rC){sh=img.height; sw=sh*rC;}else{sw=img.width; sh=sw/rC;} sx=(img.width-sw)*(d.x/100); sy=(img.height-sh)*(d.y/100); ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h); }
    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function renderLayers() {
        const l = document.getElementById('layerList'); l.innerHTML = "";
        state.texts.forEach(t => {
            const d = document.createElement('div'); d.style = "padding:2px; border-bottom:1px solid #eee; cursor:pointer;";
            if(state.editingId === t.id) d.style.background = "#fff9c4";
            d.innerHTML = `${t.text.substring(0,15)}... <b onclick="delT(${t.id})">‚úñ</b>`;
            d.onclick = () => { state.editingId = t.id; loadTextToEdit(t.id); draw(); };
            l.appendChild(d);
        });
    }
    function loadTextToEdit(id) { const t=state.texts.find(x=>x.id===id); document.getElementById('tInput').value=t.text; document.getElementById('tGlow').checked=t.glow; document.getElementById('tColor').value=t.color; }
    function closeFooterModal() { 
        state.footer.tel = document.getElementById('fTel').value;
        state.footer.web = document.getElementById('fWeb').value;
        state.footer.name = document.getElementById('fName').value;
        document.getElementById('footerModal').style.display='none'; draw(); 
    }
    function openFooterModal() { document.getElementById('footerModal').style.display='block'; }
    function download() { const a=document.createElement('a'); a.download='ilan.jpg'; a.href=canvas.toDataURL('image/jpeg', 0.95); a.click(); }
    function loadT(n) { const t=JSON.parse(localStorage.getItem('emlak_pro_temps'))[n]; Object.assign(state, t); for(let k in state.imgs) if(state.imgs[k].src){ const i=new Image(); i.onload=draw; i.src=state.imgs[k].src; state.imgs[k].obj=i; } draw(); renderLayers(); }
    window.onload = () => { refreshTemplates(); saveToHistory(); draw(); };
</script>

</body>
</html>
