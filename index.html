<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak St√ºdyosu V33 (Master Repair & Print)</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; overflow: hidden; color: #333; }
        .wrapper { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
        .sidebar { background: white; padding: 15px; border-right: 3px solid #2c3e50; overflow-y: auto; height: 100%; position: relative; }
        
        /* Marka */
        .brand-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .brand-logo-svg { width: 44px; height: 44px; }
        .brand-text h1 { margin: 0; font-size: 20px; font-family: 'Montserrat', sans-serif; font-weight: 900; color: #2c3e50; line-height: 1; }
        .brand-text span { font-size: 10px; color: #f1c40f; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

        .group-title { font-size: 11px; font-weight: 900; color: #ffffff; text-transform: uppercase; margin: 20px 0 10px 0; background: #2c3e50; padding: 10px 12px; border-left: 6px solid #f1c40f; border-radius: 0 4px 4px 0; }

        /* Butonlar */
        .project-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-main { border: none; padding: 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; text-align: center; color: white; transition: 0.2s; }
        .btn-undo { background: #e74c3c; grid-column: span 2; margin-bottom: 5px; }
        .btn-save { background: #2c3e50; }
        .btn-load { background: #34495e; }
        .btn-new { background: #8e44ad; grid-column: span 2; padding: 12px; margin-top: 5px; }
        
        .active-project-name { font-size: 10px; color: #27ae60; font-weight: bold; text-align: center; grid-column: span 2; margin-top: 5px; background: #eafaf1; padding: 4px; border-radius: 4px; }

        .img-item { display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; margin-bottom: 6px; background: #fff; }
        .img-item.active { border-color: #3498db; background: #eaf6ff; border-left: 5px solid #3498db; }
        .file-name-display { font-size: 10px; color: #3498db; font-weight: 600; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .btn-remove-img { background: #ffebeb; color: #e74c3c; border: 1px solid #ffcccc; border-radius: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Metin Edit√∂r√º */
        .text-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #ddd; }
        .hf-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box; margin-bottom: 8px; }
        
        .color-palette { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .palette-circle { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }

        /* ƒ∞leti≈üim Butonlarƒ± (Vurgulu) */
        .btn-comm { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-wp { background: #25d366; color: white; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); }
        .btn-print { background: #34495e; color: white; }
        .btn-jpg { background: #2c3e50; color: #f1c40f; border: 2px solid #f1c40f; }

        /* Canvas Alanƒ± */
        .canvas-area { background: #5f6c7b; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden; }
        canvas { box-shadow: 0 25px 60px rgba(0,0,0,0.5); max-width: 100%; max-height: 95vh; background: white; border: 5px solid #fff; }

        /* Katman Listesi */
        .layer-list { margin-top: 10px; border: 1px solid #ddd; background: #fff; max-height: 120px; overflow-y: auto; border-radius: 6px; }
        .layer-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 12px; cursor: pointer; }
        .layer-row.selected { background: #eaf6ff; border-left: 4px solid #3498db; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; backdrop-filter: blur(5px); }
        .modal-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; width: 500px; padding: 20px; }

        /* PRINT STYLES */
        @media print {
            body * { visibility: hidden; }
            #canvas, #canvas * { visibility: visible; }
            #canvas { position: fixed; left: 0; top: 0; width: 100% !important; height: auto !important; max-height: 100vh; object-fit: contain; }
            @page { size: auto; margin: 0mm; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-header">
            <svg class="brand-logo-svg" viewBox="0 0 100 100"><path d="M10 30V10H30" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M70 10H90V30" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M50 35L30 50H40V70H60V50H70L50 35Z" fill="#2c3e50"/><circle cx="50" cy="52" r="6" fill="#f1c40f"/></svg>
            <div class="brand-text"><h1>EMLAK</h1><h1 style="color:#2c3e50">ST√úDYOSU</h1><span>V33 REPAIR PRO</span></div>
        </div>

        <div class="group-title">1. Proje Y√∂netimi</div>
        <div class="project-actions">
            <button class="btn-main btn-undo" onclick="undo()">‚Ü© Geri Al (Undo)</button>
            <button class="btn-main btn-save" onclick="saveProject()">üíæ Kaydet</button>
            <button class="btn-main btn-load" onclick="document.getElementById('projectLoader').click()">üìÇ Y√ºkle</button>
            <button class="btn-main btn-new" onclick="resetProject()">‚ú® SIFIRLA / YENƒ∞ PROJE</button>
            <div class="active-project-name" id="projectNameLabel">Aktif Proje: Yeni ƒ∞lan</div>
            <input type="file" id="projectLoader" accept=".json" style="display:none" onchange="loadProject(this)">
        </div>

        <div class="group-title">2. G√∂rseller & Detaylar</div>
        <div class="img-selector-list">
            <div class="img-item active" onclick="selectActiveImg('main')" id="item-main">
                <div style="flex:1"><label style="font-size:11px; font-weight:900;">‚≠ê Ana Vitrin</label><span class="file-name-display" id="name-main">Se√ßilmedi</span></div>
                <input type="file" id="file-main" style="display:none" onchange="loadImg(this, 'main')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-main').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('main', event)">‚úñ</button>
            </div>
            <div class="img-item" onclick="selectActiveImg('sub1')" id="item-sub1"><div style="flex:1"><label style="font-size:11px; font-weight:800;">Detay 1</label><span class="file-name-display" id="name-sub1">Se√ßilmedi</span></div><input type="file" id="file-sub1" style="display:none" onchange="loadImg(this, 'sub1')"><button class="btn-remove-img" onclick="removeImg('sub1', event)">‚úñ</button></div>
            <div class="img-item" onclick="selectActiveImg('sub2')" id="item-sub2"><div style="flex:1"><label style="font-size:11px; font-weight:800;">Detay 2</label><span class="file-name-display" id="name-sub2">Se√ßilmedi</span></div><input type="file" id="file-sub2" style="display:none" onchange="loadImg(this, 'sub2')"><button class="btn-remove-img" onclick="removeImg('sub2', event)">‚úñ</button></div>
        </div>

        <div class="group-title">3. Serbest Metin & Katmanlar</div>
        <div class="text-box">
            <input type="text" id="tTxt" class="hf-input" placeholder="Metni buraya yazƒ±n...">
            <div class="color-palette">
                <div class="palette-circle" onclick="setTColor('#f1c40f')" style="background:#f1c40f;"></div>
                <div class="palette-circle" onclick="setTColor('#003399')" style="background:#003399;"></div>
                <div class="palette-circle" onclick="setTColor('#ffffff')" style="background:#ffffff;"></div>
                <input type="color" id="tColor" value="#ffffff" oninput="draw()" style="width:30px; height:24px; border:none; background:transparent; cursor:pointer;">
            </div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <select id="tEffect" class="hf-input" style="flex:2;" onchange="draw()">
                    <option value="none">Efekt Yok</option>
                    <option value="lightsaber">üåü I≈üƒ±n Kƒ±lƒ±cƒ± (Ultra Glow)</option>
                    <option value="neon">üíé Modern Neon</option>
                    <option value="fire">üî• Ate≈ü Parlamasƒ±</option>
                </select>
                <input type="number" id="tSize" value="60" style="width:50px; border:1px solid #ddd; border-radius:4px; padding:5px;">
            </div>
            <button id="btnAction" class="btn-main" style="background:#f39c12; width:100%; padding:12px;" onclick="handleTextAction()">‚ûï KATMAN EKLE / G√úNCELLE</button>
            <div id="textPosSettings" style="margin-top:10px; display:none; background:#eee; padding:10px; border-radius:5px;">
                <div style="font-size:10px; font-weight:bold;">KONUM AYARI (X - Y)</div>
                <input type="range" id="txtX" min="0" max="100" oninput="moveText('x', this.value)" style="width:100%">
                <input type="range" id="txtY" min="0" max="100" oninput="moveText('y', this.value)" style="width:100%">
            </div>
        </div>
        <div id="layerList" class="layer-list"></div>

        <div class="group-title">4. Payla≈üƒ±m & √áƒ±ktƒ±</div>
        <button class="btn-comm btn-wp" onclick="shareOnWhatsApp()">üì≤ WHATSAPP'TA PAYLA≈û</button>
        <button class="btn-comm btn-print" onclick="printCanvas()">üñ®Ô∏è YAZDIR (A4 OTOMATƒ∞K)</button>
        <button class="btn-comm btn-jpg" onclick="download()">üíæ JPG OLARAK KAYDET</button>
        <div style="height:50px"></div>
    </div>

    <div class="canvas-area"><canvas id="canvas"></canvas></div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let state = {
        format: 'post', activeImgKey: 'main', projectName: "Yeni ƒ∞lan",
        imgs: { 
            main: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, 
            sub1: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, 
            sub2: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"} 
        },
        texts: [], editingId: null
    };

    let history = [];
    function saveState() {
        const snap = JSON.stringify({
            texts: state.texts,
            imgs: Object.keys(state.imgs).reduce((acc, k) => { acc[k] = {...state.imgs[k], obj:null}; return acc; }, {})
        });
        history.push(snap); if(history.length > 20) history.shift();
    }

    function undo() {
        if(history.length === 0) return;
        const last = JSON.parse(history.pop());
        state.texts = last.texts;
        for(let k in state.imgs) {
            state.imgs[k].x = last.imgs[k].x; state.imgs[k].y = last.imgs[k].y;
            state.imgs[k].fileName = last.imgs[k].fileName; document.getElementById('name-'+k).innerText = state.imgs[k].fileName;
            if(last.imgs[k].src !== state.imgs[k].src) {
                state.imgs[k].src = last.imgs[k].src;
                if(state.imgs[k].src) { const i=new Image(); i.src=state.imgs[k].src; i.onload=()=>{state.imgs[k].obj=i; draw();}; } else state.imgs[k].obj=null;
            }
        }
        renderLayerList(); draw();
    }

    function draw() {
        canvas.width = 1080; canvas.height = 1080;
        ctx.fillStyle = "#ecf0f1"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Ana Resim
        if (state.imgs.main.obj) drawCr(ctx, state.imgs.main, 0, 0, 1080, 1080);

        // Metin Katmanlarƒ±
        state.texts.forEach(t => {
            ctx.save();
            const tx = canvas.width * (t.x / 100);
            const ty = canvas.height * (t.y / 100);
            ctx.font = `bold ${t.size}px Montserrat`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";

            if (t.effect === 'lightsaber') {
                ctx.shadowColor = t.color;
                [30, 60, 90].forEach(b => { ctx.shadowBlur = b; ctx.strokeText(t.text, tx, ty); });
                ctx.lineWidth = 3; ctx.strokeStyle = "#fff"; ctx.strokeText(t.text, tx, ty);
            } else if (t.effect === 'neon') {
                ctx.shadowColor = t.color; ctx.shadowBlur = 40;
                ctx.strokeStyle = t.color; ctx.lineWidth = 4; ctx.strokeText(t.text, tx, ty);
            } else if (t.effect === 'fire') {
                ctx.shadowColor = "#ff4500"; ctx.shadowBlur = 40;
            } else {
                ctx.shadowColor = "rgba(0,0,0,0.8)"; ctx.shadowBlur = 10; ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4;
            }

            ctx.fillStyle = t.color;
            ctx.fillText(t.text, tx, ty);
            ctx.restore();
        });
    }

    function drawCr(c,d,x,y,w,h) { 
        const i=d.obj, rB=w/h, rI=i.width/i.height; let sw,sh,sx,sy; 
        if(rI>rB){sh=i.height; sw=sh*rB;} else {sw=i.width; sh=sw/rB;} 
        sx=(i.width-sw)*(d.x/100); sy=(i.height-sh)*(d.y/100); 
        c.drawImage(i,sx,sy,sw,sh,x,y,w,h); 
    }

    // Metin Fonksiyonlarƒ±
    function handleTextAction(){
        const v = document.getElementById('tTxt').value; if(!v) return;
        saveState();
        const s = document.getElementById('tSize').value, c = document.getElementById('tColor').value, ef = document.getElementById('tEffect').value;
        
        if(state.editingId !== null){
            const t = state.texts.find(x => x.id === state.editingId);
            t.text = v; t.size = s; t.color = c; t.effect = ef;
            cancelEdit();
        } else {
            const id = Date.now();
            state.texts.push({id, text:v, size:s, color:c, effect:ef, x:50, y:50});
            loadTextToEdit(id);
        }
        draw(); renderLayerList();
    }

    function loadTextToEdit(id){
        const t = state.texts.find(x => x.id === id);
        state.editingId = id;
        document.getElementById('tTxt').value = t.text;
        document.getElementById('tSize').value = t.size;
        document.getElementById('tColor').value = t.color;
        document.getElementById('tEffect').value = t.effect || 'none';
        document.getElementById('textPosSettings').style.display = 'block';
        document.getElementById('txtX').value = t.x;
        document.getElementById('txtY').value = t.y;
        document.getElementById('btnAction').innerText = "G√úNCELLE ‚úÖ";
        renderLayerList();
    }

    function moveText(a, v){ if(state.editingId){ state.texts.find(x => x.id === state.editingId)[a] = v; draw(); } }
    function cancelEdit(){ state.editingId = null; document.getElementById('tTxt').value = ""; document.getElementById('textPosSettings').style.display = 'none'; document.getElementById('btnAction').innerText = "‚ûï KATMAN EKLE"; renderLayerList(); }
    function setTColor(hex){ document.getElementById('tColor').value = hex; draw(); }
    function renderLayerList(){ 
        const l = document.getElementById('layerList'); l.innerHTML = '';
        state.texts.forEach(t => {
            const row = document.createElement('div');
            row.className = `layer-row ${t.id === state.editingId ? 'selected' : ''}`;
            row.onclick = () => loadTextToEdit(t.id);
            row.innerHTML = `<span style="flex:1">${t.text}</span><button style="background:red; color:white; border:none; border-radius:3px; padding:2px 6px;" onclick="delTx(${t.id},event)">‚úñ</button>`;
            l.appendChild(row);
        });
    }
    function delTx(id, e){ e.stopPropagation(); saveState(); state.texts = state.texts.filter(x => x.id !== id); if(state.editingId===id) cancelEdit(); renderLayerList(); draw(); }

    // G√∂rsel Fonksiyonlarƒ±
    function selectActiveImg(k){ state.activeImgKey = k; document.querySelectorAll('.img-item').forEach(e => e.classList.remove('active')); document.getElementById('item-'+k).classList.add('active'); }
    function loadImg(inp, k){
        if(inp.files[0]){
            saveState();
            const fName = inp.files[0].name; state.imgs[k].fileName = fName; document.getElementById('name-'+k).innerText = fName;
            const r = new FileReader();
            r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { state.imgs[k].obj = i; state.imgs[k].src = e.target.result; draw(); }; };
            r.readAsDataURL(inp.files[0]);
        }
    }
    function removeImg(k, e){ e.stopPropagation(); saveState(); state.imgs[k].obj = null; state.imgs[k].src = null; state.imgs[k].fileName = "Se√ßilmedi"; document.getElementById('name-'+k).innerText = "Se√ßilmedi"; draw(); }

    // Payla≈üƒ±m & √áƒ±ktƒ±
    async function shareOnWhatsApp() {
        try {
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.95));
            const file = new File([blob], 'ilan.jpg', { type: 'image/jpeg' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: state.projectName });
            } else { alert("Bu tarayƒ±cƒ± payla≈üƒ±mƒ± desteklemiyor."); }
        } catch (e) { console.error(e); }
    }

    function printCanvas() { window.print(); }
    function download(){ const a = document.createElement('a'); a.download = state.projectName + '.jpg'; a.href = canvas.toDataURL('image/jpeg', 0.95); a.click(); }
    function resetProject(){ if(confirm('Sƒ±fƒ±rlansƒ±n mƒ±?')) location.reload(); }

    // Yedekleme Sistemi
    function saveProject() {
        const data = { texts: state.texts, imgs: {} };
        for(let k in state.imgs) if(state.imgs[k].src) data.imgs[k] = {src: state.imgs[k].src, x: state.imgs[k].x, y: state.imgs[k].y, fileName: state.imgs[k].fileName};
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = state.projectName + '.json'; a.click();
    }

    function loadProject(input) {
        if(!input.files[0]) return;
        state.projectName = input.files[0].name.replace('.json',''); document.getElementById('projectNameLabel').innerText = "Aktif: " + state.projectName;
        const reader = new FileReader();
        reader.onload = function(e) {
            const d = JSON.parse(e.target.result);
            state.texts = d.texts || [];
            for(let k in d.imgs) {
                state.imgs[k].x = d.imgs[k].x; state.imgs[k].y = d.imgs[k].y;
                state.imgs[k].fileName = d.imgs[k].fileName || "Bilinmiyor"; document.getElementById('name-'+k).innerText = state.imgs[k].fileName;
                state.imgs[k].src = d.imgs[k].src;
                if(state.imgs[k].src) { const img = new Image(); img.src = state.imgs[k].src; img.onload = () => { state.imgs[k].obj = img; draw(); }; }
            }
            renderLayerList(); draw();
        };
        reader.readAsText(input.files[0]);
    }

    function updateMasterPos(a, v){ state.imgs[state.activeImgKey][a] = v; draw(); }
</script>

<div style="display:none;">
    <input type="range" id="masterX" oninput="updateMasterPos('x', this.value)">
    <input type="range" id="masterY" oninput="updateMasterPos('y', this.value)">
</div>

</body>
</html>
