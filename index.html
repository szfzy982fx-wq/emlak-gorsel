<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak St√ºdyosu V32 (Ultra Effects & Share)</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700;900&family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; overflow: hidden; color: #333; }
        .wrapper { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
        
        .sidebar { background: white; padding: 15px; border-right: 3px solid #2c3e50; overflow-y: auto; height: 100%; position: relative; }
        
        .brand-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
        .brand-logo-svg { width: 44px; height: 44px; }
        .brand-text h1 { margin: 0; font-size: 20px; font-family: 'Montserrat', sans-serif; font-weight: 900; color: #2c3e50; line-height: 1; }
        .brand-text span { font-size: 10px; color: #f1c40f; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

        .group-title { 
            font-size: 11px; font-weight: 900; color: #ffffff; text-transform: uppercase; 
            margin: 20px 0 10px 0; background: #2c3e50; padding: 10px 12px; 
            border-left: 6px solid #f1c40f; border-radius: 0 4px 4px 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        .project-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-undo { background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: bold; grid-column: span 2; margin-bottom: 5px; }
        .btn-save { background: #2c3e50; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; }
        .btn-load { background: #34495e; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; }
        .btn-new { background: #8e44ad; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: bold; grid-column: span 2; }
        .active-project-name { font-size: 10px; color: #27ae60; font-weight: bold; text-align: center; grid-column: span 2; margin-top: 5px; background: #eafaf1; padding: 4px; border-radius: 4px; }

        .btn-toggle { flex: 1; padding: 8px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; text-align: center; }
        .btn-toggle.active { background: #3498db; color: white; border-color: #3498db; }

        .img-item { display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; position: relative; margin-bottom: 6px; background: #fff; }
        .img-item.active { border-color: #3498db; background: #eaf6ff; border-left: 5px solid #3498db; }
        .file-name-display { font-size: 10px; color: #3498db; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-top: 3px; font-style: italic; }
        .btn-remove-img { background: #ffebeb; color: #e74c3c; border: 1px solid #ffcccc; border-radius: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; font-weight: bold; }

        .master-controls { background: #2c3e50; color: white; padding: 12px; border-radius: 8px; margin-top: 10px; position: sticky; top: 0; z-index: 10; }
        .control-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .control-row span { font-size: 11px; width: 50px; text-align: right; opacity: 0.9; font-weight: bold; }
        .control-row input { flex: 1; cursor: pointer; }

        .hf-settings { background: #34495e; color: white; padding: 12px; border-radius: 8px; font-size: 11px; margin-bottom: 10px; }
        .hf-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; gap: 5px; }
        .hf-input { width: 100%; padding: 6px; border: none; border-radius: 4px; font-size: 12px; box-sizing: border-box; }

        .canvas-area { background: #5f6c7b; display: flex; align-items: center; justify-content: center; padding: 20px; }
        canvas { box-shadow: 0 25px 60px rgba(0,0,0,0.5); max-width: 100%; max-height: 95vh; object-fit: contain; background: white; border: 5px solid #fff; }
        
        .color-palette { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .palette-circle { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .palette-circle:hover { transform: scale(1.2); border-color: #3498db; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 998; backdrop-filter: blur(4px); }
        .modal-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 999; width: 580px; }
        .modal-header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-radius: 12px 12px 0 0; }
        .modal-body { padding: 25px; }

        .layer-list { margin-top: 10px; border: 1px solid #ddd; background: #f9f9f9; max-height: 150px; overflow-y: auto; border-radius: 6px; }
        .layer-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 12px; cursor: pointer; }
        .layer-row.selected { background: #eaf6ff; border-left: 4px solid #3498db; font-weight: bold; }
        .f-mode-btn { flex:1; background:transparent; border:none; color:#aaa; cursor:pointer; padding:5px; font-size:10px; font-weight:bold; border-radius:3px; }
        .f-mode-btn.active { background:white; color:#333; }

        /* YENƒ∞ BUTONLAR */
        .btn-comm { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 13px; }
        .btn-wp { background: #25d366; color: white; }
        .btn-print { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand-header">
            <svg class="brand-logo-svg" viewBox="0 0 100 100" fill="none">
                <path d="M10 30V10H30" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M70 10H90V30" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M10 70V90H30" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M90 70V90H70" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/><path d="M50 35L30 50H40V70H60V50H70L50 35Z" fill="#2c3e50"/><circle cx="50" cy="52" r="6" fill="#f1c40f"/>
            </svg>
            <div class="brand-text"><h1>EMLAK</h1><h1 style="color:#2c3e50">ST√úDYOSU</h1><span>V32 ULTRA PRO</span></div>
        </div>

        <div class="group-title">1. Proje Y√∂netimi</div>
        <div class="project-actions">
            <button class="btn-undo" onclick="undo()">‚Ü© Geri Al</button>
            <button class="btn-save" onclick="saveProject()">üíæ Kaydet</button>
            <button class="btn-load" onclick="document.getElementById('projectLoader').click()">üìÇ Y√ºkle</button>
            <button class="btn-new" onclick="resetProject()">‚ú® YENƒ∞ PROJE</button>
            <div class="active-project-name" id="projectNameLabel">Aktif Proje: Yeni ƒ∞lan</div>
            <input type="file" id="projectLoader" accept=".json" style="display:none" onchange="loadProject(this)">
        </div>

        <div class="group-title">2. Format & Galeri Pozisyonu</div>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <button class="btn-toggle active" id="btn-post" onclick="setFormat('post')">Kare Post</button>
            <button class="btn-toggle" id="btn-story" onclick="setFormat('story')">Hikaye</button>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <button class="btn-toggle" style="background:#f1c40f; color:#000;" onclick="setLayout('bottom')">Yatay ≈ûerit</button>
            <button class="btn-toggle" style="background:#f1c40f; color:#000;" onclick="setLayout('side')">Dikey ≈ûerit</button>
        </div>
        <div class="hf-settings" style="background: #27ae60;">
            <div class="control-row"><span>En</span> <input type="range" id="galW" min="10" max="100" value="95" onmousedown="saveState()" oninput="updateGal('w', this.value)"></div>
            <div class="control-row"><span>Boy</span> <input type="range" id="galH" min="10" max="80" value="25" onmousedown="saveState()" oninput="updateGal('h', this.value)"></div>
            <div class="control-row"><span>X</span> <input type="range" id="galX" min="0" max="100" value="50" onmousedown="saveState()" oninput="updateGal('x', this.value)"></div>
            <div class="control-row"><span>Y</span> <input type="range" id="galY" min="0" max="100" value="70" onmousedown="saveState()" oninput="updateGal('y', this.value)"></div>
        </div>

        <div class="group-title">3. G√∂rseller & Detaylar</div>
        <div class="master-controls">
            <div style="font-size:10px; display:flex; justify-content:space-between; margin-bottom:5px;">
                <span id="activeImgLabel" style="font-weight:900; color:#f1c40f;">Se√ßili: ANA Vƒ∞TRƒ∞N</span><span>KADRAJ</span>
            </div>
            <div class="control-row"><span>X</span> <input type="range" id="masterX" min="0" max="100" value="50" onmousedown="saveState()" oninput="updateMasterPos('x', this.value)"></div>
            <div class="control-row"><span>Y</span> <input type="range" id="masterY" min="0" max="100" value="50" onmousedown="saveState()" oninput="updateMasterPos('y', this.value)"></div>
            <div class="control-row" id="masterSizeRow" style="display:none; border-top:1px solid #ffffff33; padding-top:5px; margin-top:5px;">
                <span>Boyut</span> <input type="range" id="masterSize" min="5" max="100" value="20" onmousedown="saveState()" oninput="updateMasterPos('size', this.value)">
            </div>
        </div>

        <div class="img-selector-list" style="margin-top:10px;">
            <div class="img-item active" onclick="selectActiveImg('main')" id="item-main">
                <div class="img-label-area"><label>‚≠ê Ana Vitrin</label><span class="file-name-display" id="name-main">Se√ßilmedi</span></div>
                <input type="file" id="file-main" style="display:none" onchange="loadImg(this, 'main')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-main').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('main', event)">‚úñ</button>
            </div>
            <div class="img-item" onclick="selectActiveImg('sub1')" id="item-sub1">
                <div class="img-label-area"><label>Detay 1</label><span class="file-name-display" id="name-sub1">Se√ßilmedi</span></div>
                <input type="file" id="file-sub1" style="display:none" onchange="loadImg(this, 'sub1')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-sub1').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('sub1', event)">‚úñ</button>
            </div>
            <div class="img-item" onclick="selectActiveImg('sub2')" id="item-sub2">
                <div class="img-label-area"><label>Detay 2</label><span class="file-name-display" id="name-sub2">Se√ßilmedi</span></div>
                <input type="file" id="file-sub2" style="display:none" onchange="loadImg(this, 'sub2')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-sub2').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('sub2', event)">‚úñ</button>
            </div>
            <div class="group-title" style="margin-top:15px; background:#34495e;">LOGOLAR</div>
            <div class="img-item" onclick="selectActiveImg('logo1')" id="item-logo1">
                <div class="img-label-area"><label>Logo 1</label><span class="file-name-display" id="name-logo1">Se√ßilmedi</span></div>
                <input type="file" id="file-logo1" style="display:none" onchange="loadImg(this, 'logo1')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-logo1').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('logo1', event)">‚úñ</button>
            </div>
            <div class="img-item" onclick="selectActiveImg('logo2')" id="item-logo2">
                <div class="img-label-area"><label>Logo 2</label><span class="file-name-display" id="name-logo2">Se√ßilmedi</span></div>
                <input type="file" id="file-logo2" style="display:none" onchange="loadImg(this, 'logo2')">
                <button class="btn-remove-img" style="background:#f1f4f8; color:#333; margin-right:5px;" onclick="document.getElementById('file-logo2').click(); event.stopPropagation();">üìÇ</button>
                <button class="btn-remove-img" onclick="removeImg('logo2', event)">‚úñ</button>
            </div>
        </div>

        <div class="group-title">4. Pro Header (√úst ≈ûerit)</div>
        <div class="hf-settings">
            <label><input type="checkbox" id="showHeader" onchange="saveState(); draw()"> Ba≈ülƒ±ƒüƒ± Aktif Et</label>
            <div style="margin-top:8px; border-top:1px solid #ffffff33; padding-top:8px;">
                <input type="text" id="headerText" class="hf-input" placeholder="ƒ∞lan Ba≈ülƒ±ƒüƒ±..." onmousedown="saveState()" oninput="draw()">
                <div class="control-row"><span>Boy</span> <input type="range" id="headerHeight" min="50" max="300" value="80" onmousedown="saveState()" oninput="draw()"></div>
                <div class="hf-row">
                    <select id="headerFont" class="hf-input" onchange="saveState(); draw()"><option value="'Montserrat'">Modern</option><option value="'Dancing Script'">El Yazƒ±sƒ±</option><option value="'Bebas Neue'">G√º√ßl√º</option></select>
                    <input type="number" id="headerFontSize" class="hf-input" style="width:40px" value="40" oninput="draw()">
                    <label><input type="checkbox" id="headerItalic" onchange="saveState(); draw()"> /</label>
                </div>
                <div class="hf-row"><span>BG</span> <input type="color" id="headerBg" value="#ffffff" onchange="draw()"> <span>Yazƒ±</span> <input type="color" id="headerColor" value="#003399" onchange="draw()"></div>
            </div>
        </div>

        <div class="group-title">5. Alt ≈ûerit (Footer)</div>
        <div class="hf-settings">
            <label><input type="checkbox" id="showFooter" checked onchange="saveState(); draw()"> Footer Aktif</label>
            <div style="display:flex; gap:5px; margin:8px 0;"><button class="f-mode-btn active" id="fModeSimple" onclick="setFooterMode('simple')">Basit</button><button class="f-mode-btn" id="fModeVitrin" onclick="setFooterMode('vitrin')">Vitrin</button></div>
            <div id="simpleFooterSettings">
                <input type="text" id="footerTel" class="hf-input" placeholder="Telefon..." oninput="draw()">
                <input type="text" id="footerWeb" class="hf-input" placeholder="Web Adresi..." oninput="draw()">
            </div>
            <div id="vitrinFooterSettings" style="display:none;">
                <div class="control-row"><span>Boy</span> <input type="range" id="footerHeight" min="100" max="450" value="200" onmousedown="saveState()" oninput="draw()"></div>
                <button onclick="toggleFooterModal()" style="width:100%; padding:10px; cursor:pointer; background:#e67e22; color:white; border:none; border-radius:4px; font-weight:bold;">‚úèÔ∏è DANI≈ûMAN & √ñZELLƒ∞KLER</button>
            </div>
            <div class="hf-row" style="margin-top:8px;"><span>Zemin</span> <input type="color" id="footerColor" value="#000000" onchange="saveState(); draw()"></div>
        </div>

        <div class="group-title">6. Serbest Metin & Katmanlar</div>
        <div class="text-box">
            <button class="btn-emoji-open" onclick="toggleEmojiModal()" style="width:100%; background:#fff; border:1px dashed #ccc; padding:8px; margin-bottom:10px; cursor:pointer; font-weight:bold;">üòä EMOJƒ∞ SE√á</button>
            <input type="text" id="tTxt" class="hf-input" style="width:100%; color:#333; background:white; border:1px solid #ddd; padding:8px;" placeholder="Metin yazƒ±n...">
            
            <div style="color:#000; font-size:10px; font-weight:bold; margin:10px 0 5px 0;">HIZLI RENK VE ULTRA EFEKT:</div>
            <div class="color-palette">
                <div class="palette-circle" onclick="setTColor('#f1c40f')" style="background:#f1c40f;"></div>
                <div class="palette-circle" onclick="setTColor('#003399')" style="background:#003399;"></div>
                <div class="palette-circle" onclick="setTColor('#ffffff')" style="background:#ffffff;"></div>
                <input type="color" id="tColor" value="#ffffff" oninput="draw()" style="width:30px; height:22px; border:none; background:transparent;">
                <select id="tEffect" class="hf-input" style="width:auto; height:22px; padding:0; border:1px solid #ddd; font-size:10px;" onchange="draw()">
                    <option value="none">Efekt: Yok</option>
                    <option value="lightsaber">üåü I≈ûIN KILICI (Ultra)</option>
                    <option value="neon">üíé Neon I≈üƒ±ma</option>
                    <option value="fire">üî• Ate≈ü Parlamasƒ±</option>
                    <option value="stars">‚ú® Yƒ±ldƒ±z Yaƒümuru</option>
                </select>
            </div>

            <div style="display:flex; gap:5px; margin:8px 0; align-items:center;">
                <select id="tFont" class="hf-input" style="background:white; border:1px solid #ddd; flex:2;">
                    <option value="'Montserrat'">Modern</option><option value="'Bebas Neue'">G√º√ßl√º</option><option value="'Dancing Script'">El Yazƒ±sƒ±</option>
                </select>
                <input type="number" id="tSize" value="60" style="width:45px; border:1px solid #ddd; border-radius:4px; padding:5px;">
                <label style="font-size:11px; font-weight:bold; cursor:pointer;"><input type="checkbox" id="tItalic"> /</label>
            </div>
            <button id="btnAction" class="btn-action" style="width:100%; padding:10px; background:#f39c12; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="handleTextAction()">‚ûï KATMAN EKLE</button>
        </div>
        <div id="layerList" class="layer-list"></div>

        <button class="btn-comm btn-wp" onclick="shareOnWhatsApp()">üì≤ WHATSAPP'TA PAYLA≈û</button>
        <button class="btn-comm btn-print" onclick="printCanvas()">üñ®Ô∏è YAZDIR (PDF/A4)</button>
        <button class="btn-download" style="margin-top:10px; background:#2c3e50; width:100%;" onclick="download()">üíæ JPG OLARAK KAYDET</button>
        <div style="height:60px"></div>
    </div>

    <div class="canvas-area"><canvas id="canvas"></canvas></div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-box" id="emojiModal" style="display:none; width:260px;">
        <div class="modal-header"><span>Emojiler</span><span onclick="closeAllModals()" style="cursor:pointer">‚úñ</span></div>
        <div class="modal-body"><div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"><button onclick="ins('üè†')" style="font-size:26px; cursor:pointer">üè†</button><button onclick="ins('üìç')" style="font-size:26px; cursor:pointer">üìç</button><button onclick="ins('üìû')" style="font-size:26px; cursor:pointer">üìû</button><button onclick="ins('üî•')" style="font-size:26px; cursor:pointer">üî•</button><button onclick="ins('‚úÖ')" style="font-size:26px; cursor:pointer">‚úÖ</button><button onclick="ins('‚≠ê')" style="font-size:26px; cursor:pointer">‚≠ê</button><button onclick="ins('üíé')" style="font-size:26px; cursor:pointer">üíé</button><button onclick="ins('üîë')" style="font-size:26px; cursor:pointer">üîë</button></div></div>
    </div>
    <div class="modal-box" id="footerModal" style="display:none; width:560px;">
        <div class="modal-header"><span>üè¢ Kurumsal Bilgi Giri≈üi</span><span onclick="closeAllModals()" style="cursor:pointer">‚úñ</span></div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <label style="font-weight:bold; font-size:11px;">üë§ DANI≈ûMAN</label>
                    <input type="text" id="agentName" placeholder="Ad Soyad" class="hf-input" style="border:1px solid #ddd; margin-bottom:5px;">
                    <input type="text" id="agentTitle" placeholder="√únvan" class="hf-input" style="border:1px solid #ddd; margin-bottom:5px;">
                    <input type="text" id="agentExtra" placeholder="GSM / Ofis" class="hf-input" style="border:1px solid #ddd; margin-bottom:5px;">
                    <input type="file" onchange="loadAgentImg(this)" style="font-size:10px; margin-top:5px;">
                </div>
                <div>
                    <label style="font-weight:bold; font-size:11px;">üìã √ñZELLƒ∞KLER (6 ADET)</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                        <input type="text" id="feat1" placeholder="√ñzellik 1" class="hf-input" style="border:1px solid #ddd;">
                        <input type="text" id="feat2" placeholder="√ñzellik 2" class="hf-input" style="border:1px solid #ddd;">
                        <input type="text" id="feat3" placeholder="√ñzellik 3" class="hf-input" style="border:1px solid #ddd;">
                        <input type="text" id="feat4" placeholder="√ñzellik 4" class="hf-input" style="border:1px solid #ddd;">
                        <input type="text" id="feat5" placeholder="√ñzellik 5" class="hf-input" style="border:1px solid #ddd;">
                        <input type="text" id="feat6" placeholder="√ñzellik 6" class="hf-input" style="border:1px solid #ddd;">
                    </div>
                </div>
            </div>
            <button onclick="closeAllModals(); draw();" style="width:100%; margin-top:20px; padding:12px; background:#27ae60; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">UYGULA VE KAPAT</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let state = {
        format: 'post', activeImgKey: 'main', projectName: "Yeni ƒ∞lan",
        imgs: { 
            main: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, 
            sub1: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, sub2: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, 
            sub3: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, sub4: {obj:null, src:null, x:50, y:50, fileName: "Se√ßilmedi"}, 
            logo1: {obj:null, src:null, x:10, y:5, size:15, fileName: "Se√ßilmedi"}, logo2: {obj:null, src:null, x:50, y:5, size:15, fileName: "Se√ßilmedi"}, logo3: {obj:null, src:null, x:90, y:5, size:15, fileName: "Se√ßilmedi"} 
        },
        footer: { mode: 'simple', agentImg: null, agentImgSrc: null },
        gallery: { w: 95, h: 25, x: 50, y: 70 },
        texts: [], editingId: null
    };

    let history = [];
    function saveState() {
        const snap = {
            format: state.format, gallery: {...state.gallery}, texts: JSON.parse(JSON.stringify(state.texts)),
            footerMode: state.footer.mode, footerImg: state.footer.agentImgSrc,
            dom: {
                showHeader: document.getElementById('showHeader').checked, headerText: document.getElementById('headerText').value, 
                headerH: document.getElementById('headerHeight').value, headerF: document.getElementById('headerFont').value,
                headerFS: document.getElementById('headerFontSize').value, headerI: document.getElementById('headerItalic').checked,
                headerBg: document.getElementById('headerBg').value, headerColor: document.getElementById('headerColor').value,
                showFooter: document.getElementById('showFooter').checked, footerTel: document.getElementById('footerTel').value,
                footerWeb: document.getElementById('footerWeb').value, footerH: document.getElementById('footerHeight').value,
                footerC: document.getElementById('footerColor').value, agentN: document.getElementById('agentName').value,
                agentT: document.getElementById('agentTitle').value, agentE: document.getElementById('agentExtra').value,
                feats: [1,2,3,4,5,6].map(n=>document.getElementById('feat'+n).value)
            }
        };
        for(let k in state.imgs) snap[k] = {...state.imgs[k], obj:null};
        history.push(JSON.stringify(snap)); if(history.length > 20) history.shift();
    }

    function undo() {
        if(history.length === 0) return;
        const last = JSON.parse(history.pop());
        state.format = last.format; state.gallery = last.gallery; state.texts = last.texts; state.footer.mode = last.footerMode;
        const d = last.dom;
        document.getElementById('showHeader').checked = d.showHeader; document.getElementById('headerText').value = d.headerText;
        document.getElementById('headerHeight').value = d.headerH; document.getElementById('headerFont').value = d.headerF;
        document.getElementById('headerFontSize').value = d.headerFS; document.getElementById('headerItalic').checked = d.headerI;
        document.getElementById('headerBg').value = d.headerBg; document.getElementById('headerColor').value = d.headerColor;
        document.getElementById('showFooter').checked = d.showFooter; document.getElementById('footerTel').value = d.footerTel;
        document.getElementById('footerWeb').value = d.footerWeb; document.getElementById('footerHeight').value = d.footerH;
        document.getElementById('footerColor').value = d.footerC; document.getElementById('agentName').value = d.agentN;
        document.getElementById('agentTitle').value = d.agentT; document.getElementById('agentExtra').value = d.agentE;
        d.feats.forEach((f,i)=> { if(document.getElementById('feat'+(i+1))) document.getElementById('feat'+(i+1)).value=f; });
        for(let k in state.imgs) {
            state.imgs[k].x = last[k].x; state.imgs[k].y = last[k].y; state.imgs[k].size = last[k].size;
            state.imgs[k].fileName = last[k].fileName; document.getElementById('name-'+k).innerText = state.imgs[k].fileName;
            if(last[k].src !== state.imgs[k].src) {
                state.imgs[k].src = last[k].src;
                if(state.imgs[k].src) { const i=new Image(); i.src=state.imgs[k].src; i.onload=()=>{state.imgs[k].obj=i; draw();}; } else state.imgs[k].obj=null;
            }
        }
        state.footer.agentImgSrc = last.footerImg;
        if(state.footer.agentImgSrc) { const i=new Image(); i.src=state.footer.agentImgSrc; i.onload=()=>{state.footer.agentImg=i; draw();}; } else state.footer.agentImg=null;
        setFooterMode(state.footer.mode); renderLayerList(); draw();
    }

    // WHATSAPP PAYLA≈ûMA (WEB SHARE API)
    async function shareOnWhatsApp() {
        try {
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const blob = await (await fetch(dataUrl)).blob();
            const file = new File([blob], 'ilan.jpg', { type: 'image/jpeg' });
            
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: state.projectName,
                    text: 'Gayrimenkul ƒ∞lan Detaylarƒ±'
                });
            } else {
                alert("Tarayƒ±cƒ±nƒ±z doƒürudan payla≈üƒ±mƒ± desteklemiyor. L√ºtfen ƒ∞ndir butonunu kullanƒ±n.");
            }
        } catch (err) {
            console.error('Payla≈üƒ±m hatasƒ±:', err);
        }
    }

    // YAZDIRMA FONKSƒ∞YONU
    function printCanvas() {
        const dataUrl = canvas.toDataURL();
        const windowPrint = window.open('', '');
        windowPrint.document.write(`<div style="text-align:center;"><img src="${dataUrl}" style="max-width:100%; height:auto;"></div>`);
        windowPrint.document.close();
        windowPrint.focus();
        setTimeout(() => { windowPrint.print(); windowPrint.close(); }, 500);
    }

    function setLayout(mode) {
        saveState();
        if (mode === 'bottom') state.gallery = { w: 95, h: 25, x: 50, y: 70 };
        else if (mode === 'side') state.gallery = { w: 25, h: 80, x: 85, y: 50 };
        document.getElementById('galW').value = state.gallery.w; document.getElementById('galH').value = state.gallery.h;
        document.getElementById('galX').value = state.gallery.x; document.getElementById('galY').value = state.gallery.y;
        draw();
    }

    function setTColor(hex) { document.getElementById('tColor').value = hex; draw(); }

    function draw() {
        canvas.width = 1080; canvas.height = state.format === 'post' ? 1080 : 1920;
        ctx.fillStyle = "#ecf0f1"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (state.imgs.main.obj) drawCr(ctx, state.imgs.main, 0, 0, canvas.width, canvas.height);

        const hH = document.getElementById('showHeader').checked ? parseInt(document.getElementById('headerHeight').value) : 0;
        if (hH > 0) {
            ctx.fillStyle = document.getElementById('headerBg').value; ctx.fillRect(0,0,canvas.width,hH); ctx.fillStyle = document.getElementById('headerColor').value;
            ctx.font = `${document.getElementById('headerItalic').checked?'italic ':''}bold ${document.getElementById('headerFontSize').value}px ${document.getElementById('headerFont').value}`;
            ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(document.getElementById('headerText').value, canvas.width/2, hH/2);
        }

        const fH = document.getElementById('showFooter').checked ? (state.footer.mode==='simple' ? (state.format==='story'?120:100) : parseInt(document.getElementById('footerHeight').value)) : 0;
        if (fH > 0) {
            const fY = canvas.height - fH; ctx.fillStyle = document.getElementById('footerColor').value; ctx.fillRect(0, fY, canvas.width, fH);
            if (state.footer.mode === 'simple') {
                ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.font="bold 36px Montserrat"; ctx.fillText(document.getElementById('footerTel').value, canvas.width/2, fY+fH*0.4);
                ctx.font="24px Montserrat"; ctx.fillText(document.getElementById('footerWeb').value, canvas.width/2, fY+fH*0.75);
            } else {
                const p=fH*0.1, is=fH*0.7;
                if(state.footer.agentImg) { ctx.save(); ctx.beginPath(); ctx.arc(p+is/2, fY+fH/2, is/2, 0, Math.PI*2); ctx.clip(); drawCr(ctx, {obj:state.footer.agentImg, x:50, y:50}, p, fY+(fH-is)/2, is, is); ctx.restore(); }
                
                ctx.fillStyle="#fff"; ctx.textAlign="left"; 
                const nameSize = fH * 0.15; const subSize = fH * 0.10; const featSize = fH * 0.11;
                ctx.font=`bold ${nameSize}px Montserrat`; ctx.fillText(document.getElementById('agentName').value, p+is+20, fY + fH*0.35);
                ctx.font=`${subSize}px Montserrat`; ctx.fillText(document.getElementById('agentTitle').value.toUpperCase(), p+is+20, fY + fH*0.55);
                ctx.font=`bold ${subSize}px Montserrat`; ctx.fillText(document.getElementById('agentExtra').value, p+is+20, fY + fH*0.75);
                
                const fs = [1,2,3,4,5,6].map(n=>document.getElementById('feat'+n).value).filter(v=>v);
                fs.forEach((f,i)=>{ 
                    const col = i % 2, row = Math.floor(i/2); 
                    const fx = canvas.width*0.58 + (col * (canvas.width*0.2)); const fy = fY + (fH*0.15) + (row * (fH*0.25)); 
                    ctx.fillStyle="#f1c40f"; ctx.font=`bold ${featSize*1.1}px Arial`; ctx.fillText("‚úì", fx-30, fy + featSize/2); 
                    ctx.fillStyle="#fff"; ctx.font=`bold ${featSize}px Arial`; ctx.fillText(f, fx, fy + featSize/2); 
                });
            }
        }

        const subs = [state.imgs.sub1, state.imgs.sub2, state.imgs.sub3, state.imgs.sub4].filter(i=>i.obj);
        if (subs.length > 0) {
            const gw = canvas.width * (state.gallery.w/100), gh = canvas.height * (state.gallery.h/100);
            const gx = (canvas.width - gw) * (state.gallery.x/100), gy = (canvas.height - gh) * (state.gallery.y/100);
            ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(gx-10, gy-10, gw+20, gh+20);
            const gap=15; let cols = gw > gh ? subs.length : (gw > gh*0.5 ? 2 : 1); let rows = Math.ceil(subs.length/cols); const cw = (gw - (cols-1)*gap)/cols, ch = (gh - (rows-1)*gap)/rows;
            subs.forEach((img, i)=>{ const c=i%cols, r=Math.floor(i/cols); const ix=gx+c*(cw+gap), iy=gy+r*(ch+gap); ctx.fillStyle="#fff"; ctx.fillRect(ix-3, iy-3, cw+6, ch+6); drawCr(ctx, img, ix, iy, cw, ch); });
        }

        // --- ULTRA EFEKT MOTORU ---
        state.texts.forEach(t => {
            ctx.save();
            const tx = canvas.width * (t.x / 100);
            const ty = canvas.height * (t.y / 100);
            ctx.font = `${t.italic ? 'italic ' : ''}bold ${t.size}px ${t.font}`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";

            if (t.effect === 'lightsaber') {
                // I≈ûIN KILICI EFEKTƒ∞ (3 Katmanlƒ± Aura)
                ctx.shadowColor = t.color;
                ctx.shadowBlur = 30; ctx.strokeText(t.text, tx, ty);
                ctx.shadowBlur = 60; ctx.strokeText(t.text, tx, ty);
                ctx.shadowBlur = 90; ctx.strokeText(t.text, tx, ty);
                ctx.lineWidth = 2; ctx.strokeStyle = "#fff"; // Beyaz √ßekirdek koru
                ctx.strokeText(t.text, tx, ty);
            } else if (t.effect === 'neon') {
                ctx.shadowColor = t.color; ctx.shadowBlur = 40;
                ctx.strokeStyle = t.color; ctx.lineWidth = 4; ctx.strokeText(t.text, tx, ty);
            } else if (t.effect === 'fire') {
                ctx.shadowColor = "#ff4500"; ctx.shadowBlur = 50;
                ctx.fillStyle = "#f1c40f"; ctx.fillText(t.text, tx, ty);
            } else if (t.effect === 'stars') {
                ctx.fillStyle = "#fff";
                for(let i=0; i<12; i++) {
                    const sx = tx + (Math.random()-0.5)*300; const sy = ty + (Math.random()-0.5)*150;
                    ctx.beginPath(); ctx.arc(sx, sy, Math.random()*4, 0, Math.PI*2); ctx.fill();
                }
            } else {
                ctx.shadowColor = "rgba(0,0,0,0.85)"; ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
            }

            ctx.fillStyle = t.color;
            ctx.fillText(t.text, tx, ty);
            ctx.restore();
        });

        ['logo1','logo2','logo3'].forEach(k=>{ if(state.imgs[k].obj) { const i=state.imgs[k].obj, lw=canvas.width*(state.imgs[k].size/100), lh=lw*(i.height/i.width); ctx.drawImage(i, (canvas.width-lw)*(state.imgs[k].x/100), (canvas.height-lh)*(state.imgs[k].y/100), lw, lh); } });
    }

    function drawCr(c,d,x,y,w,h) { const i=d.obj, rB=w/h, rI=i.width/i.height; let sw,sh,sx,sy; if(rI>rB){sh=i.height; sw=sh*rB;} else {sw=i.width; sh=sw/rB;} sx=(i.width-sw)*(d.x/100); sy=(i.height-sh)*(d.y/100); c.drawImage(i,sx,sy,sw,sh,x,y,w,h); }
    function updateGal(a,v){ state.gallery[a]=parseInt(v); draw(); }
    function selectActiveImg(k){ state.activeImgKey=k; document.querySelectorAll('.img-item').forEach(e=>e.classList.remove('active')); document.getElementById('item-'+k).classList.add('active'); document.getElementById('activeImgLabel').innerText="Se√ßili: "+k.toUpperCase(); document.getElementById('masterX').value=state.imgs[k].x; document.getElementById('masterY').value=state.imgs[k].y; document.getElementById('masterSizeRow').style.display=k.startsWith('logo')?'flex':'none'; if(k.startsWith('logo'))document.getElementById('masterSize').value=state.imgs[k].size; }
    function updateMasterPos(a,v){ state.imgs[state.activeImgKey][a]=v; draw(); }
    
    function loadImg(inp,k){ if(inp.files[0]){ saveState(); const fName = inp.files[0].name; state.imgs[k].fileName = fName; document.getElementById('name-'+k).innerText = fName; const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{state.imgs[k].obj=i; state.imgs[k].src=e.target.result; draw();}; }; r.readAsDataURL(inp.files[0]); } }
    function removeImg(k,e){ e.stopPropagation(); saveState(); state.imgs[k].obj=null; state.imgs[k].src=null; state.imgs[k].fileName = "Se√ßilmedi"; document.getElementById('name-'+k).innerText = "Se√ßilmedi"; draw(); }
    
    function handleTextAction(){ 
        const v=document.getElementById('tTxt').value; if(!v)return; 
        saveState(); 
        const f=document.getElementById('tFont').value, s=document.getElementById('tSize').value, c=document.getElementById('tColor').value, it=document.getElementById('tItalic').checked, ef=document.getElementById('tEffect').value;
        if(state.editingId!==null){ 
            const t=state.texts.find(x=>x.id===state.editingId); t.text=v; t.font=f; t.size=s; t.color=c; t.italic=it; t.effect=ef;
            cancelEdit(); 
        } else { 
            const id=Date.now(); state.texts.push({id, text:v, font:f, size:s, color:c, italic:it, effect:ef, x:50, y:50}); 
            loadTextToEdit(id); 
        } 
        draw(); renderLayerList(); 
    }
    function loadTextToEdit(id){ const t=state.texts.find(x=>x.id===id); state.editingId=id; document.getElementById('tTxt').value=t.text; document.getElementById('tFont').value=t.font; document.getElementById('tSize').value=t.size; document.getElementById('tColor').value=t.color; document.getElementById('tItalic').checked=t.italic; document.getElementById('tEffect').value=t.effect || 'none'; document.getElementById('textPosSettings').style.display='block'; document.getElementById('txtX').value=t.x; document.getElementById('txtY').value=t.y; document.getElementById('btnAction').innerText="G√úNCELLE ‚úÖ"; renderLayerList(); draw(); }
    function moveText(a,v){ if(state.editingId){ state.texts.find(x=>x.id===state.editingId)[a]=v; draw(); } }
    function cancelEdit(){ state.editingId=null; document.getElementById('tTxt').value=""; document.getElementById('textPosSettings').style.display='none'; document.getElementById('btnAction').innerText="‚ûï KATMAN EKLE"; renderLayerList(); draw(); }
    function delTx(id,e){ e.stopPropagation(); saveState(); state.texts=state.texts.filter(x=>x.id!==id); if(state.editingId===id)cancelEdit(); renderLayerList(); draw(); }
    function renderLayerList(){ const l=document.getElementById('layerList'); l.innerHTML=''; state.texts.forEach(t=>{ const d=document.createElement('div'); d.className=`layer-row ${t.id===state.editingId?'selected':''}`; d.onclick=()=>loadTextToEdit(t.id); d.innerHTML=`<span style="flex:1">${t.text}</span><button style="background:red; color:white; border:none; border-radius:3px; cursor:pointer;" onclick="delTx(${t.id},event)">‚úñ</button>`; l.appendChild(d); }); }
    
    function setFormat(f){ saveState(); state.format=f; draw(); document.getElementById('btn-post').className=f==='post'?'btn-toggle active':'btn-toggle'; document.getElementById('btn-story').className=f==='story'?'btn-toggle active':'btn-toggle'; }
    function setFooterMode(m){ saveState(); state.footer.mode=m; document.getElementById('fModeSimple').className=m==='simple'?'f-mode-btn active':'f-mode-btn'; document.getElementById('fModeVitrin').className=m==='vitrin'?'f-mode-btn active':'f-mode-btn'; document.getElementById('simpleFooterSettings').style.display=m==='simple'?'block':'none'; document.getElementById('vitrinFooterSettings').style.display=m==='vitrin'?'block':'none'; draw(); }
    function toggleEmojiModal(){ document.getElementById('modalOverlay').style.display='block'; document.getElementById('emojiModal').style.display='block'; }
    function toggleFooterModal(){ document.getElementById('modalOverlay').style.display='block'; document.getElementById('footerModal').style.display='block'; }
    function closeAllModals(){ document.getElementById('modalOverlay').style.display='none'; document.getElementById('emojiModal').style.display='none'; document.getElementById('footerModal').style.display='none'; }
    function ins(c){ document.getElementById('tTxt').value+=c+" "; document.getElementById('tTxt').focus(); }
    function loadAgentImg(i){ if(i.files[0]){ saveState(); const r=new FileReader(); r.onload=e=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{state.footer.agentImg=img; state.footer.agentImgSrc=e.target.result; draw();}; }; r.readAsDataURL(i.files[0]); } }
    function download(){ const a=document.createElement('a'); a.download='ilan.jpg'; a.href=canvas.toDataURL('image/jpeg',0.95); a.click(); }
    function resetProject(){ if(confirm('Sƒ±fƒ±rlansƒ±n mƒ±?')) location.reload(); }

    function saveProject() {
        const data = {
            projectName: state.projectName, format: state.format, texts: state.texts, gallery: state.gallery,
            footer: { 
                show: document.getElementById('showFooter').checked, mode: state.footer.mode, agentImgSrc: state.footer.agentImgSrc, 
                tel: document.getElementById('footerTel').value, web: document.getElementById('footerWeb').value, 
                h: document.getElementById('footerHeight').value, c: document.getElementById('footerColor').value, 
                name: document.getElementById('agentName').value, title: document.getElementById('agentTitle').value, extra: document.getElementById('agentExtra').value, fts: [1,2,3,4,5,6].map(n=>document.getElementById('feat'+n).value)
            },
            header: { 
                show: document.getElementById('showHeader').checked, text: document.getElementById('headerText').value, 
                h: document.getElementById('headerHeight').value, f: document.getElementById('headerFont').value,
                fs: document.getElementById('headerFontSize').value, i: document.getElementById('headerItalic').checked,
                bg: document.getElementById('headerBg').value, c: document.getElementById('headerColor').value
            },
            imgs: {}
        };
        for(let k in state.imgs) if(state.imgs[k].src) data.imgs[k] = {src: state.imgs[k].src, x: state.imgs[k].x, y: state.imgs[k].y, size: state.imgs[k].size, fileName: state.imgs[k].fileName};
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = state.projectName + '.json'; a.click();
    }

    function loadProject(input) {
        if(!input.files[0]) return;
        const fName = input.files[0].name.replace('.json','');
        state.projectName = fName; document.getElementById('projectNameLabel').innerText = "Aktif Proje: " + fName;
        const reader = new FileReader();
        reader.onload = function(e) {
            const d = JSON.parse(e.target.result);
            state.format = d.format || 'post'; state.texts = d.texts || [];
            state.gallery = d.gallery || { w: 95, h: 25, x: 50, y: 70 };
            if(d.header) {
                document.getElementById('showHeader').checked = d.header.show; document.getElementById('headerText').value = d.header.text || "";
                document.getElementById('headerHeight').value = d.header.h || 80; document.getElementById('headerFont').value = d.header.f || "'Montserrat'";
                document.getElementById('headerFontSize').value = d.header.fs || 40; document.getElementById('headerItalic').checked = d.header.i || false;
                document.getElementById('headerBg').value = d.header.bg || "#ffffff"; document.getElementById('headerColor').value = d.header.c || "#003399";
            }
            if(d.footer) {
                const f = d.footer; document.getElementById('showFooter').checked = f.show !== undefined ? f.show : true; state.footer.mode = f.mode || 'simple';
                document.getElementById('footerTel').value = f.tel || ""; document.getElementById('footerWeb').value = f.web || "";
                document.getElementById('footerHeight').value = f.h || 200; document.getElementById('footerColor').value = f.c || "#000000";
                document.getElementById('agentName').value = f.name || ""; document.getElementById('agentTitle').value = f.title || ""; document.getElementById('agentExtra').value = f.extra || "";
                if(f.fts) f.fts.forEach((val, i) => { if(document.getElementById('feat'+(i+1))) document.getElementById('feat'+(i+1)).value = val; });
                if(f.agentImgSrc) { state.footer.agentImgSrc = f.agentImgSrc; const img = new Image(); img.src = f.agentImgSrc; img.onload = () => { state.footer.agentImg = img; draw(); }; }
            }
            for(let k in d.imgs) {
                state.imgs[k].x = d.imgs[k].x; state.imgs[k].y = d.imgs[k].y; state.imgs[k].size = d.imgs[k].size || 15;
                state.imgs[k].fileName = d.imgs[k].fileName || "Bilinmiyor"; document.getElementById('name-'+k).innerText = state.imgs[k].fileName;
                state.imgs[k].src = d.imgs[k].src;
                if(state.imgs[k].src) { const img = new Image(); img.src = state.imgs[k].src; img.onload = () => { state.imgs[k].obj = img; draw(); }; }
            }
            document.getElementById('galW').value = state.gallery.w; document.getElementById('galH').value = state.gallery.h;
            document.getElementById('galX').value = state.gallery.x; document.getElementById('galY').value = state.gallery.y;
            setFormat(state.format); setFooterMode(state.footer.mode); renderLayerList(); draw();
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>
