<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karacabay Emlak St√ºdyosu V8 (Master)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; margin: 0; height: 100vh; overflow: hidden; color: #333; }
        .wrapper { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
        
        /* SOL PANEL */
        .sidebar { background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; height: 100%; }
        
        h2 { border-bottom: 2px solid #e67e22; padding-bottom: 10px; color: #2c3e50; font-size: 16px; margin-top: 0; }
        .group-title { font-size: 11px; font-weight: 800; color: #7f8c8d; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }

        /* Buton Gruplarƒ± */
        .btn-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn-toggle { flex: 1; padding: 8px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; text-align: center; }
        .btn-toggle.active { background: #3498db; color: white; border-color: #3498db; }
        .btn-toggle.disabled { opacity: 0.5; cursor: not-allowed; background: #eee; }

        /* Dosya Y√ºkleme */
        .img-card { background: #fdfdfd; border: 1px solid #eee; padding: 6px; border-radius: 6px; margin-bottom: 5px; }
        .img-card label { font-size: 10px; font-weight: bold; display: block; margin-bottom: 2px; color: #2c3e50; }
        input[type="file"] { font-size: 10px; width: 100%; }
        
        /* Sliderlar */
        .pos-controls { display: flex; gap: 5px; align-items: center; margin-top: 2px; }
        .pos-controls span { font-size: 9px; color: #999; width: 10px; }
        input[type="range"] { flex: 1; height: 4px; cursor: pointer; }

        /* Metin Edit√∂r√º & Emoji */
        .text-box { background: #fff8e1; padding: 10px; border: 1px solid #f1c40f; border-radius: 6px; }
        .input-text { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ddd; margin-bottom: 5px; font-size: 12px; }
        .btn-action { width: 100%; background: #f39c12; color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-action.update { background: #27ae60; } /* G√ºncelleme modunda ye≈üil */

        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px; margin-bottom: 5px; }
        .emoji-btn { background: white; border: 1px solid #ddd; cursor: pointer; font-size: 16px; padding: 2px; border-radius: 4px; }
        .emoji-btn:hover { background: #eee; }

        /* Katman Listesi */
        .layer-list { margin-top: 5px; border: 1px solid #eee; border-radius: 4px; background: #fafafa; max-height: 150px; overflow-y: auto; }
        .layer-row { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #eee; font-size: 11px; cursor: pointer; }
        .layer-row:hover { background: #f0f0f0; }
        .layer-row.selected { background: #d5eafc; border-left: 3px solid #3498db; }
        .del-btn { background: #e74c3c; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; margin-left: 5px; }

        /* Footer Ayarlarƒ± */
        .footer-settings { background: #2c3e50; color: white; padding: 10px; border-radius: 6px; }
        .footer-input { width: 100%; padding: 5px; margin-bottom: 5px; font-size: 11px; border: none; border-radius: 3px; }

        .btn-download { background: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* SAƒû PANEL */
        .canvas-area { background: #5f6c7b; display: flex; align-items: center; justify-content: center; padding: 20px; }
        canvas { box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 100%; max-height: 95vh; object-fit: contain; background: white; }

        @media (max-width: 900px) { .wrapper { grid-template-columns: 1fr; overflow-y: auto; } }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <h2>üíé Emlak St√ºdyosu V8 (Master)</h2>

        <div class="group-title">1. Format & D√ºzen</div>
        <div class="btn-group">
            <div class="btn-toggle active" id="btn-post" onclick="setFormat('post')">Kare (Post)</div>
            <div class="btn-toggle" id="btn-story" onclick="setFormat('story')">Hikaye (Story)</div>
        </div>
        <div class="btn-group">
            <div class="btn-toggle active" id="btn-btm" onclick="setLayout('bottom')">Alt ≈ûerit</div>
            <div class="btn-toggle" id="btn-side" onclick="setLayout('side')">Yan ≈ûerit</div>
        </div>

        <div class="group-title">2. G√∂rseller & Kadraj</div>
        <div class="img-card" style="border-left: 3px solid #e74c3c;">
            <label>ANA RESƒ∞M</label>
            <input type="file" accept="image/*" onchange="loadImg(this, 'main')">
            <div class="pos-controls">
                <span>‚Üî</span> <input type="range" min="0" max="100" value="50" oninput="setPos('main', 'x', this.value)">
                <span>‚Üï</span> <input type="range" min="0" max="100" value="50" oninput="setPos('main', 'y', this.value)">
            </div>
        </div>
        <div class="img-card"><label>Detaylar (Mutfak, Banyo...)</label>
            <input type="file" accept="image/*" onchange="loadImg(this, 'sub1')">
            <input type="file" accept="image/*" onchange="loadImg(this, 'sub2')">
            <input type="file" accept="image/*" onchange="loadImg(this, 'sub3')">
            <input type="file" accept="image/*" onchange="loadImg(this, 'sub4')">
            </div>

        <div class="group-title">3. Metin & Emoji</div>
        <div class="text-box">
            <div class="emoji-grid">
                <button class="emoji-btn" onclick="addEmoji('üìç')">üìç</button>
                <button class="emoji-btn" onclick="addEmoji('üìû')">üìû</button>
                <button class="emoji-btn" onclick="addEmoji('üè†')">üè†</button>
                <button class="emoji-btn" onclick="addEmoji('üî•')">üî•</button>
                <button class="emoji-btn" onclick="addEmoji('üîë')">üîë</button>
                <button class="emoji-btn" onclick="addEmoji('üèä')">üèä</button>
            </div>

            <input type="text" id="tTxt" class="input-text" placeholder="Metin yazƒ±n...">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <select id="tFont" style="flex:1"><option value="Arial">Arial</option><option value="Impact">Impact</option><option value="Georgia">Georgia</option></select>
                <input type="number" id="tSize" value="60" style="width:50px">
                <input type="color" id="tColor" value="#ffffff" style="width:30px; border:none;">
            </div>
            
            <button id="btnAction" class="btn-action" onclick="handleTextAction()">‚ûï EKLE</button>
            <button id="btnCancel" onclick="cancelEdit()" style="display:none; width:100%; margin-top:5px; font-size:10px; cursor:pointer;">ƒ∞ptal</button>
        </div>

        <div id="layerList" class="layer-list"></div>
        
        <div id="textPosControls" style="display:none; margin-top:5px;">
            <label style="font-size:10px;">Se√ßili Metni Kaydƒ±r:</label>
            <div class="pos-controls">
                <span>‚Üî</span> <input type="range" id="txtX" min="0" max="100" oninput="moveSelected('x', this.value)">
            </div>
            <div class="pos-controls">
                <span>‚Üï</span> <input type="range" id="txtY" min="0" max="100" oninput="moveSelected('y', this.value)">
            </div>
        </div>

        <div class="group-title">4. Kurumsal Footer</div>
        <div class="footer-settings">
            <label style="font-size:10px; display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                <input type="checkbox" id="showFooter" onchange="draw()"> Footer ≈ûeridi G√∂ster
            </label>
            <input type="text" id="footerTel" class="footer-input" placeholder="Tel: 0532 000 00 00" oninput="draw()">
            <input type="text" id="footerWeb" class="footer-input" placeholder="Web: www.karacabay.com" oninput="draw()">
            <label style="font-size:10px;">≈ûerit Rengi:</label>
            <input type="color" id="footerColor" value="#000000" style="width:100%; height:20px;" oninput="draw()">
        </div>

        <div class="group-title">5. Logo</div>
        <div class="img-card">
            <input type="file" accept="image/*" onchange="loadImg(this, 'logo')">
            <div class="pos-controls">
                <span style="font-size:9px">Boy</span> <input type="range" min="5" max="50" value="20" oninput="state.logoSize=this.value; draw();">
            </div>
            <div class="pos-controls">
                <span>X</span> <input type="range" min="0" max="100" value="90" oninput="state.logoX=this.value; draw();">
                <span>Y</span> <input type="range" min="0" max="100" value="5" oninput="state.logoY=this.value; draw();">
            </div>
        </div>

        <button class="btn-download" onclick="download()">üíæ G√ñRSELƒ∞ ƒ∞NDƒ∞R</button>
        <div style="height:50px"></div>
    </div>

    <div class="canvas-area">
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // STATE
    const state = {
        format: 'post', layout: 'bottom',
        logoSize: 20, logoX: 90, logoY: 5,
        imgs: { main: {obj:null, x:50, y:50}, sub1: null, sub2: null, sub3: null, sub4: null, logo: null },
        texts: [],
        editingId: null // Hangi metni d√ºzenliyoruz?
    };

    window.onload = () => draw();

    // 1. FORMAT AYARLARI
    function setFormat(f) {
        state.format = f;
        document.querySelectorAll('#btn-post, #btn-story').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + f).classList.add('active');

        // STORY MODUNDA YAN ≈ûERƒ∞T KAPATILIR
        const sideBtn = document.getElementById('btn-side');
        if (f === 'story') {
            setLayout('bottom');
            sideBtn.classList.add('disabled');
            sideBtn.onclick = null; // Tƒ±klamayƒ± engelle
        } else {
            sideBtn.classList.remove('disabled');
            sideBtn.onclick = function(){ setLayout('side') };
        }
        draw();
    }

    function setLayout(l) {
        state.layout = l;
        document.querySelectorAll('#btn-btm, #btn-side').forEach(b => b.classList.remove('active'));
        document.getElementById(l==='bottom'?'btn-btm':'btn-side').classList.add('active');
        draw();
    }

    // 2. RESƒ∞M Y√úKLEME
    function loadImg(input, key) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const i = new Image();
                i.onload = () => {
                    if(key === 'logo') state.imgs.logo = i;
                    else if(key.startsWith('sub')) state.imgs[key] = i;
                    else state.imgs[key].obj = i;
                    draw();
                };
                i.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function setPos(key, axis, val) {
        state.imgs[key][axis] = val;
        draw();
    }

    // 3. METƒ∞N & EMOJI ƒ∞≈ûLEMLERƒ∞ (GELƒ∞≈ûMƒ∞≈û)
    function addEmoji(char) {
        document.getElementById('tTxt').value += char + " ";
    }

    function handleTextAction() {
        const val = document.getElementById('tTxt').value;
        if(!val) return;

        const font = document.getElementById('tFont').value;
        const size = document.getElementById('tSize').value;
        const color = document.getElementById('tColor').value;

        if (state.editingId !== null) {
            // G√úNCELLEME
            const txt = state.texts.find(t => t.id === state.editingId);
            if(txt) {
                txt.text = val; txt.font = font; txt.size = size; txt.color = color;
            }
            cancelEdit(); // Moddan √ßƒ±k
        } else {
            // YENƒ∞ EKLEME
            state.texts.push({
                id: Date.now(), text: val, font: font, size: size, color: color, x: 50, y: 50
            });
            // Yeni ekleneni otomatik se√ß
            loadTextToEdit(state.texts[state.texts.length-1].id);
        }
        draw();
        renderLayerList();
    }

    function loadTextToEdit(id) {
        const txt = state.texts.find(t => t.id === id);
        if(!txt) return;

        state.editingId = id;
        
        // Inputlarƒ± doldur
        document.getElementById('tTxt').value = txt.text;
        document.getElementById('tFont').value = txt.font;
        document.getElementById('tSize').value = txt.size;
        document.getElementById('tColor').value = txt.color;
        
        // Butonu "G√ºncelle" yap
        const btn = document.getElementById('btnAction');
        btn.innerText = "G√úNCELLE";
        btn.classList.add('update');
        document.getElementById('btnCancel').style.display = 'block';

        // Konum Sliderlarƒ±nƒ± Aktif Et ve Deƒüerleri Ata
        document.getElementById('textPosControls').style.display = 'block';
        document.getElementById('txtX').value = txt.x;
        document.getElementById('txtY').value = txt.y;

        renderLayerList(); // Listeyi g√ºncelle (se√ßili class'ƒ± i√ßin)
    }

    function cancelEdit() {
        state.editingId = null;
        document.getElementById('tTxt').value = "";
        document.getElementById('btnAction').innerText = "‚ûï EKLE";
        document.getElementById('btnAction').classList.remove('update');
        document.getElementById('btnCancel').style.display = 'none';
        document.getElementById('textPosControls').style.display = 'none';
        renderLayerList();
    }

    function moveSelected(axis, val) {
        if (state.editingId !== null) {
            const txt = state.texts.find(t => t.id === state.editingId);
            if(txt) { txt[axis] = val; draw(); }
        }
    }

    function renderLayerList() {
        const el = document.getElementById('layerList');
        el.innerHTML = '';
        state.texts.forEach(t => {
            const isSelected = t.id === state.editingId;
            const div = document.createElement('div');
            div.className = `layer-row ${isSelected ? 'selected' : ''}`;
            div.innerHTML = `
                <span onclick="loadTextToEdit(${t.id})" style="flex:1;">${t.text}</span>
                <button class="del-btn" onclick="delTx(${t.id})">Sil</button>
            `;
            el.appendChild(div);
        });
    }

    function delTx(id) {
        state.texts = state.texts.filter(t => t.id !== id);
        if (state.editingId === id) cancelEdit();
        renderLayerList();
        draw();
    }

    // --- √áƒ∞Zƒ∞M MOTORU ---
    function draw() {
        canvas.width = 1080;
        canvas.height = state.format === 'post' ? 1080 : 1920;
        
        // Arkaplan
        ctx.fillStyle = "#ecf0f1";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // 1. Ana Resim
        if(state.imgs.main.obj) {
            drawCropped(ctx, state.imgs.main, 0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle="#ccc"; ctx.font="40px Arial"; ctx.textAlign="center";
            ctx.fillText("Ana Resim Y√ºkleyin", canvas.width/2, canvas.height/2);
        }

        // 2. Alt Resimler
        const activeSubs = [state.imgs.sub1, state.imgs.sub2, state.imgs.sub3, state.imgs.sub4].filter(i=>i);
        if(activeSubs.length > 0) {
            if(state.format === 'story') {
                // Story Modu (Her zaman alt ≈üerit)
                const stripH = canvas.height * 0.3;
                // Footer varsa biraz daha yukarƒ± kaydƒ±r
                const footerOffset = document.getElementById('showFooter').checked ? 100 : 0;
                const startY = canvas.height - stripH - 100 - footerOffset;

                ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0, startY, canvas.width, stripH + 200);

                const gap=20; 
                const cw=(canvas.width - gap*3)/2; 
                const ch=(stripH - gap)/2;

                activeSubs.forEach((img, i)=>{
                    if(i>3) return;
                    const col=i%2; const row=Math.floor(i/2);
                    const x=gap + col*(cw+gap);
                    const y=startY + gap + row*(ch+gap);
                    ctx.fillStyle="#fff"; ctx.fillRect(x-5, y-5, cw+10, ch+10);
                    drawImageCover(ctx, img, x, y, cw, ch);
                });

            } else if(state.layout === 'side') {
                // Yan ≈ûerit
                const sw = canvas.width * 0.28;
                const sx = canvas.width - sw;
                ctx.fillStyle="rgba(255,255,255,0.95)"; ctx.fillRect(sx, 0, sw, canvas.height);
                
                const ch = (canvas.height - (activeSubs.length+1)*10) / activeSubs.length;
                activeSubs.forEach((img, i)=>{
                    const y = 10 + i*(ch+10);
                    drawImageCover(ctx, img, sx+10, y, sw-20, ch);
                });
            } else {
                // Alt ≈ûerit (Post)
                const stripH = canvas.height * 0.25;
                const footerOffset = document.getElementById('showFooter').checked ? 80 : 0;
                const startY = canvas.height - stripH - 20 - footerOffset;
                
                ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0, startY-20, canvas.width, stripH+40);
                
                const gap=20;
                const cw=(canvas.width - (activeSubs.length+1)*gap)/activeSubs.length;
                activeSubs.forEach((img, i)=>{
                    const x=gap + i*(cw+gap);
                    ctx.fillStyle="#fff"; ctx.fillRect(x-5, startY-5, cw+10, stripH+10);
                    drawImageCover(ctx, img, x, startY, cw, stripH);
                });
            }
        }

        // 3. Logo
        if(state.imgs.logo) {
            const img=state.imgs.logo;
            const lw=canvas.width*(state.logoSize/100);
            const lh=lw*(img.height/img.width);
            const lx=(canvas.width-lw)*(state.logoX/100);
            const ly=(canvas.height-lh)*(state.logoY/100);
            ctx.shadowColor="rgba(0,0,0,0.5)"; ctx.shadowBlur=10;
            ctx.drawImage(img, lx, ly, lw, lh);
            ctx.shadowBlur=0;
        }

        // 4. FOOTER ≈ûERƒ∞Dƒ∞ (EN √úST KATMAN)
        if (document.getElementById('showFooter').checked) {
            const footerH = state.format === 'story' ? 120 : 100; // Story'de daha b√ºy√ºk
            const footerY = canvas.height - footerH;
            
            // ≈ûerit
            ctx.fillStyle = document.getElementById('footerColor').value;
            ctx.fillRect(0, footerY, canvas.width, footerH);

            // Metinler
            ctx.fillStyle = "#ffffff";
            ctx.font = `bold ${state.format==='story'?40:35}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            const tel = document.getElementById('footerTel').value;
            const web = document.getElementById('footerWeb').value;

            // Eƒüer ikisi de varsa alt alta veya yan yana
            if (tel && web) {
                ctx.fillText(tel, canvas.width/2, footerY + (footerH*0.35));
                ctx.font = `${state.format==='story'?30:25}px Arial`;
                ctx.fillText(web, canvas.width/2, footerY + (footerH*0.75));
            } else {
                // Tek bilgi varsa ortala
                ctx.fillText(tel || web, canvas.width/2, footerY + (footerH/2));
            }
        }

        // 5. METƒ∞NLER
        state.texts.forEach(t => {
            const x = canvas.width * (t.x/100);
            const y = canvas.height * (t.y/100);
            ctx.save();
            ctx.font = `bold ${t.size}px ${t.font}`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=8;
            ctx.fillStyle = t.color;
            ctx.fillText(t.text, x, y);
            // Se√ßiliyse etrafƒ±na kesik √ßizgi at (Edit modunda olduƒüunu anlamak i√ßin)
            if (t.id === state.editingId) {
                ctx.strokeStyle = "red"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                const m = ctx.measureText(t.text);
                ctx.strokeRect(x - m.width/2 - 10, y - t.size/2 - 5, m.width + 20, t.size*1.2);
            }
            ctx.restore();
        });
    }

    // YARDIMCILAR
    function drawCropped(ctx, imgData, x, y, w, h) {
        const img = imgData.obj;
        const rBox = w/h; const rImg = img.width/img.height;
        let sw, sh, sx, sy;
        if(rImg > rBox) { sh = img.height; sw = sh * rBox; } 
        else { sw = img.width; sh = sw / rBox; }
        const px = imgData.x/100; const py = imgData.y/100;
        sx = (img.width - sw) * px; sy = (img.height - sh) * py;
        ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }

    function drawImageCover(ctx, img, x, y, w, h) {
        const r = Math.min(w/img.width, h/img.height);
        let nw=img.width*r, nh=img.height*r;
        let ar=1; if(nw<w) ar=w/nw; if(Math.abs(ar-1)<1e-14 && nh<h) ar=h/nh;
        nw*=ar; nh*=ar;
        let cx=(img.width - (w/(nw/img.width))) * 0.5;
        let cy=(img.height - (h/(nh/img.height))) * 0.5;
        let cw=img.width-2*cx, ch=img.height-2*cy;
        ctx.drawImage(img, cx, cy, cw, ch, x, y, w, h);
    }

    function download() {
        const a = document.createElement('a');
        a.download = 'karacabay-master-design.jpg';
        a.href = canvas.toDataURL('image/jpeg', 0.95);
        a.click();
    }
</script>

</body>
</html>
